<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <title>SQL Server 变更数据捕获（CDC） | Document</title><meta name="description" content="">
    <link rel="preload" href="/document/assets/style-6ANAoVcY.css" as="style"><link rel="stylesheet" href="/document/assets/style-6ANAoVcY.css">
    <link rel="modulepreload" href="/document/assets/app-CUvyzFzm.js"><link rel="modulepreload" href="/document/assets/sqlserver-cdc.html-CSIHN8YG.js">
    <link rel="prefetch" href="/document/assets/index.html-i1lWAYOx.js" as="script"><link rel="prefetch" href="/document/assets/javascript-cookbook.html-D_V7sQEA.js" as="script"><link rel="prefetch" href="/document/assets/typescript-cookbook.html-CYReqr7Y.js" as="script"><link rel="prefetch" href="/document/assets/cefsharp-cookbook.html-B_-KPTPf.js" as="script"><link rel="prefetch" href="/document/assets/make-thread-safe-calls-to-windows-forms-controls.html-DMx8RPcX.js" as="script"><link rel="prefetch" href="/document/assets/dottrace.html-B-udI0tq.js" as="script"><link rel="prefetch" href="/document/assets/git-cookbook.html-uP5BoEOf.js" as="script"><link rel="prefetch" href="/document/assets/gitblit-cookbook.html-CX-d2Nvj.js" as="script"><link rel="prefetch" href="/document/assets/javascript-cookbook.html-BXfQ0ob6.js" as="script"><link rel="prefetch" href="/document/assets/typescript-cookbook.html-BYA97-NX.js" as="script"><link rel="prefetch" href="/document/assets/how-to-write-a-typescript-library.html-BmBvv7O7.js" as="script"><link rel="prefetch" href="/document/assets/npm-cookbook.html-BqhLPphN.js" as="script"><link rel="prefetch" href="/document/assets/package-manager-configuration.html-sBY_PEBO.js" as="script"><link rel="prefetch" href="/document/assets/package.json-manual.html-BVxbY97E.js" as="script"><link rel="prefetch" href="/document/assets/vite-cookbook.html-CVDvA-KP.js" as="script"><link rel="prefetch" href="/document/assets/vue-cookbook.html-BHoLgx8w.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-common-functions.html-DU53Dppu.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-performance-analysis-query-satas.html-B7Qq3hDK.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-performance-analysis.html-BAMe6NRZ.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-profiler.html-DBE4uks0.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-repair-database.html-KZx0wrnO.js" as="script"><link rel="prefetch" href="/document/assets/windows-server-performance-analysis.html-gq2rq8-j.js" as="script"><link rel="prefetch" href="/document/assets/404.html-oMcT5ubu.js" as="script"><link rel="prefetch" href="/document/assets/style-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/document/assets/docsearch-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/document/assets/index-DiZEX-Ml.js" as="script"><link rel="prefetch" href="/document/assets/mermaid.core-xoE18cY4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/document/"><img class="logo" src="/document/images/logo/logo.png" alt="Document"><span class="site-name can-hide" aria-hidden="true">Document</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/document/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/fschenzihao/document/commits/master" rel="noopener noreferrer" target="_blank" aria-label="更新日志"><!--[--><!--]--> 更新日志 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/fschenzihao/document" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/document/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/fschenzihao/document/commits/master" rel="noopener noreferrer" target="_blank" aria-label="更新日志"><!--[--><!--]--> 更新日志 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/fschenzihao/document" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">SQL Server 变更数据捕获（CDC） <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_2-1-创建cdc文件组" aria-label="2.1 创建CDC文件组"><!--[--><!--]--> 2.1 创建CDC文件组 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_2-2-启动sql-server代理服务" aria-label="2.2 启动SQL Server代理服务"><!--[--><!--]--> 2.2 启动SQL Server代理服务 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_2-3-检查当前数据库的所有者" aria-label="2.3 检查当前数据库的所有者"><!--[--><!--]--> 2.3 检查当前数据库的所有者 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-1-数据库启用cdc" aria-label="3.1 数据库启用CDC"><!--[--><!--]--> 3.1 数据库启用CDC <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-表启用cdc" aria-label="3.2 表启用CDC"><!--[--><!--]--> 3.2 表启用CDC <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_3-2-1-捕获实例" aria-label="3.2.1 捕获实例"><!--[--><!--]--> 3.2.1 捕获实例 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-2-sys-tables视图" aria-label="3.2.2 sys.tables视图"><!--[--><!--]--> 3.2.2 sys.tables视图 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-3-更改表" aria-label="3.2.3 更改表"><!--[--><!--]--> 3.2.3 更改表 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-4-查询函数" aria-label="3.2.4 查询函数"><!--[--><!--]--> 3.2.4 查询函数 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-5-元数据表" aria-label="3.2.5 元数据表"><!--[--><!--]--> 3.2.5 元数据表 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-6-代理作业" aria-label="3.2.6 代理作业"><!--[--><!--]--> 3.2.6 代理作业 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_3-3-禁用数据库变更数据捕获-cdc" aria-label="3.3 禁用数据库变更数据捕获(CDC)"><!--[--><!--]--> 3.3 禁用数据库变更数据捕获(CDC) <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-4-禁用表变更数据捕获" aria-label="3.4 禁用表变更数据捕获"><!--[--><!--]--> 3.4 禁用表变更数据捕获 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-5-监视cdc状态" aria-label="3.5 监视CDC状态"><!--[--><!--]--> 3.5 监视CDC状态 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_4-1-元数据表" aria-label="4.1 元数据表"><!--[--><!--]--> 4.1 元数据表 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#cdc-change-tables" aria-label="cdc.change_tables"><!--[--><!--]--> cdc.change_tables <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#cdc-captured-columns" aria-label="cdc.captured_columns"><!--[--><!--]--> cdc.captured_columns <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#cdc-ddl-history" aria-label="cdc.ddl_history"><!--[--><!--]--> cdc.ddl_history <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#cdc-index-columns" aria-label="cdc.index_columns"><!--[--><!--]--> cdc.index_columns <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#cdc-lsn-time-mapping" aria-label="cdc.lsn_time_mapping"><!--[--><!--]--> cdc.lsn_time_mapping <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#systranschemas" aria-label="systranschemas"><!--[--><!--]--> systranschemas <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#更改表-xxxx-ct" aria-label="更改表（xxxx_CT）"><!--[--><!--]--> 更改表（xxxx_CT） <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_4-2-数据定义语言-ddl" aria-label="4.2 数据定义语言（DDL）"><!--[--><!--]--> 4.2 数据定义语言（DDL） <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_4-3-数据操纵语言-dml" aria-label="4.3 数据操纵语言（DML)"><!--[--><!--]--> 4.3 数据操纵语言（DML) <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_4-4-捕获实例" aria-label="4.4 捕获实例"><!--[--><!--]--> 4.4 捕获实例 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><blockquote><p>📃版本: 1.5</p><p>📆日期: 2021-11-02</p></blockquote><h1 id="sql-server-变更数据捕获-cdc" tabindex="-1"><a class="header-anchor" href="#sql-server-变更数据捕获-cdc"><span>SQL Server 变更数据捕获（CDC）</span></a></h1><h1 id="_1-cdc-简介" tabindex="-1"><a class="header-anchor" href="#_1-cdc-简介"><span>1. CDC 简介</span></a></h1><p>变更数据捕获 (CDC) 可记录应用于 SQL Server 表的插入、更新和删除活动。</p><p>变更数据捕获(CDC)的<code>捕获数据源</code>为 <code>SQL Server 事务日志</code></p><p>流程图</p><p><img src="/document/images/sqlserver-cdc/cdcdataflow.gif" alt="变更数据捕获数据流"></p><ul><li>在将插入、更新和删除应用于跟踪的<code>源表</code>时，将会在日志中添加说明这些更改的项。</li><li><code>捕获进程</code>会读取日志，并在跟踪的表的关联<code>更改表</code>中添加有关更改的信息。</li><li>系统将提供一些<code>函数</code>，以枚举在更改表中指定范围内发生的更改，并以筛选的结果集的形式返回该值。</li></ul><blockquote><p><strong>引用</strong></p><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/track-changes/about-change-data-capture-sql-server?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">变更数据捕获(CDC) MSDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><h1 id="_2-准备工作" tabindex="-1"><a class="header-anchor" href="#_2-准备工作"><span>2. 准备工作</span></a></h1><h2 id="_2-1-创建cdc文件组" tabindex="-1"><a class="header-anchor" href="#_2-1-创建cdc文件组"><span>2.1 创建CDC文件组</span></a></h2><p>为了性能最大化，建议将更改表置于独立于源表的文件组中，并放置在不同的磁盘上。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> master
GO

<span class="token comment">-- 创建文件组 CDCFG</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2016
<span class="token keyword">ADD</span> FILEGROUP CDCFG
GO

<span class="token comment">-- 添加文件 CDCdat1 到 文件组 CDCFG</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2016
<span class="token keyword">ADD</span> <span class="token keyword">FILE</span>
<span class="token punctuation">(</span>
    NAME <span class="token operator">=</span> CDCdat1<span class="token punctuation">,</span>
    FILENAME <span class="token operator">=</span> <span class="token string">&#39;G:\Program Files\Microsoft SQL Server\MSSQL13.SQL16\MSSQL\DATA\CDCdat1.ndf&#39;</span><span class="token punctuation">,</span>
    SIZE <span class="token operator">=</span> <span class="token number">5</span>MB<span class="token punctuation">,</span>
    MAXSIZE <span class="token operator">=</span> UNLIMITED<span class="token punctuation">,</span>
    FILEGROWTH <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">%</span>
<span class="token punctuation">)</span>
<span class="token keyword">TO</span> FILEGROUP CDCFG<span class="token punctuation">;</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_2-2-启动sql-server代理服务" tabindex="-1"><a class="header-anchor" href="#_2-2-启动sql-server代理服务"><span>2.2 启动SQL Server代理服务</span></a></h2><p><a href="https://docs.microsoft.com/zh-cn/sql/ssms/agent/start-stop-or-pause-the-sql-server-agent-service?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">启动、停止或暂停 SQL Server 代理服务<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><blockquote><p><strong>注意</strong></p><p>对表启用变更数据捕获时，SQL Server 代理不必正在运行。 但是，<strong><u>只有当 SQL Server 代理正在运行时，捕获进程才会处理事务日志并将条目写入更改表。</u></strong></p></blockquote><h2 id="_2-3-检查当前数据库的所有者" tabindex="-1"><a class="header-anchor" href="#_2-3-检查当前数据库的所有者"><span>2.3 检查当前数据库的所有者</span></a></h2><p>启用CDC前，需要先检查当前数据库的所有者，若为<code>null</code>或者非<code>sa</code>用户时，则建议将所有者更改为登录名<code>sa</code>。</p><p>否则后续开启CDC操作可能失败。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> d<span class="token punctuation">.</span>name<span class="token punctuation">,</span> d<span class="token punctuation">.</span>owner_sid<span class="token punctuation">,</span> sl<span class="token punctuation">.</span>name
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> <span class="token keyword">AS</span> d
	<span class="token keyword">left</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>sql_logins <span class="token keyword">AS</span> sl
		<span class="token keyword">ON</span> d<span class="token punctuation">.</span>owner_sid <span class="token operator">=</span> sl<span class="token punctuation">.</span>sid<span class="token punctuation">;</span>
		
<span class="token comment">/* 结果
name                owner_sid                         name
------------------- --------------------------------- -----------------------------
master              0x01                              sa
tempdb              0x01                              sa
model               0x01                              sa
msdb                0x01                              sa
AdventureWorks2016  0x010500000000000515000           NULL
*/</span>

<span class="token comment">-- AdventureWorks2016 name(所有者)为NULL（空）</span>
<span class="token comment">-- 将所有者变更更改为登录名sa</span>
<span class="token keyword">USE</span> <span class="token punctuation">[</span>AdventureWorks2016<span class="token punctuation">]</span>
GO
<span class="token keyword">ALTER</span> <span class="token keyword">AUTHORIZATION</span> <span class="token keyword">ON</span> <span class="token keyword">DATABASE</span>::<span class="token punctuation">[</span>AdventureWorks2016<span class="token punctuation">]</span> <span class="token keyword">TO</span> <span class="token punctuation">[</span>sa<span class="token punctuation">]</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h1 id="_3-启用更改数据捕获-cdc-流程" tabindex="-1"><a class="header-anchor" href="#_3-启用更改数据捕获-cdc-流程"><span>3. 启用更改数据捕获（CDC）流程</span></a></h1><h2 id="_3-1-数据库启用cdc" tabindex="-1"><a class="header-anchor" href="#_3-1-数据库启用cdc"><span>3.1 数据库启用CDC</span></a></h2><p>为数据库启用“更改数据捕获”，通过 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-db-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_enable_db (MSDN Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 存储过程实现：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016  
GO  

<span class="token comment">-- 对当前数据库启用变更数据捕获</span>
<span class="token comment">-- 注意：无法在 系统数据库 或分发数据库上启用变更数据捕获。</span>
<span class="token comment">-- is_cdc_enabled：是否已启用CDC</span>
<span class="token keyword">IF</span> <span class="token operator">NOT</span> <span class="token keyword">EXISTS</span><span class="token punctuation">(</span> <span class="token keyword">SELECT</span>  <span class="token number">1</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> <span class="token keyword">WHERE</span> name <span class="token operator">=</span> <span class="token string">&#39;AdventureWorks2016&#39;</span> <span class="token operator">and</span> is_cdc_enabled  <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">)</span>
<span class="token keyword">BEGIN</span>
	<span class="token comment">-- 返回代码值 </span>
	<span class="token comment">-- 0（成功）或 1（失败） </span>
	<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_enable_db 
<span class="token keyword">END</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当对数据库成功启用了变更数据捕获之后：</p><ul><li><p>如果数据库还原到其他服务器，默认情况下将禁用变更数据捕获，并删除所有相关的元数据。</p><p>若要保留变更数据捕获，请在还原数据库时使用 <strong>KEEP_CDC</strong> 选项。</p></li><li><p>将 <code>sys.databases</code>目录视图中的数据库条目的 is_cdc_enabled 列设置为1</p></li><li><p>并将为数据库创建以下对象：</p></li></ul><table><thead><tr><th style="text-align:center;">元数据表</th><th style="text-align:center;">DDL 触发器</th><th style="text-align:center;">cdc schema（架构）</th><th style="text-align:center;">cdc 数据库用户</th></tr></thead><tbody><tr><td style="text-align:center;"><img src="/document/images/sqlserver-cdc/E48E7325.png" alt=""></td><td style="text-align:center;"><img src="/document/images/sqlserver-cdc/33EB10F7.png" alt=""></td><td style="text-align:center;"><img src="/document/images/sqlserver-cdc/5E20673A.png" alt=""></td><td style="text-align:center;"><img src="/document/images/sqlserver-cdc/970FAF5E.png" alt=""></td></tr></tbody></table><ul><li>即使恢复模式设置为简单恢复，日志截断点也不会向前推进，直到为捕获标记的所有更改都已由捕获进程收集为止。 如果捕获进程未运行且有要收集的更改，执行 CHECKPOINT 将不会截断日志。</li></ul><h2 id="_3-2-表启用cdc" tabindex="-1"><a class="header-anchor" href="#_3-2-表启用cdc"><span>3.2 表启用CDC</span></a></h2><p>​ 对表启用变更数据捕获时，应用于此表的每个数据操纵语言 (DML) 操作的记录都将写入事务日志中。 变更数据捕获进程将从日志中检索此信息，并将其写入更改表中。</p><p>通过<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-enable-table-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_enable_table<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>存储过程实现：</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 创建一个捕获实例</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_enable_table  
    <span class="token variable">@source_schema</span> <span class="token operator">=</span> N<span class="token string">&#39;HumanResources&#39;</span>  <span class="token comment">-- 源表所属的架构的名称(默认dbo)</span>
  <span class="token punctuation">,</span> <span class="token variable">@source_name</span> <span class="token operator">=</span> N<span class="token string">&#39;Department&#39;</span>  		<span class="token comment">-- 源表的名称</span>
  <span class="token punctuation">,</span> <span class="token variable">@role_name</span> <span class="token operator">=</span> <span class="token boolean">null</span>  <span class="token comment">-- 用于访问更改数据的数据库角色的名称,null则不限制访问。</span>
  <span class="token punctuation">,</span> <span class="token variable">@capture_instance</span> <span class="token operator">=</span> <span class="token boolean">null</span> <span class="token comment">-- 捕获实例的名称, null则按源架构名称加上 schemaname_sourcename 格式生成。（例如HumanResources_Department） </span>
  <span class="token punctuation">,</span> <span class="token variable">@supports_net_changes</span> <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment">-- 是否为此捕获实例启用用于查询净更改的支持。</span>
  <span class="token punctuation">,</span> <span class="token variable">@index_name</span> <span class="token operator">=</span> <span class="token boolean">null</span> <span class="token comment">-- 用于唯一标识源表中的行的唯一索引的名称, null则取主键。</span>
  <span class="token punctuation">,</span> <span class="token variable">@captured_column_list</span> <span class="token operator">=</span> <span class="token boolean">null</span> <span class="token comment">-- 标识要捕获的源表列（逗号隔开‘ID,Code,Name’），NULL则所有列都将捕获。</span>
  <span class="token punctuation">,</span> <span class="token variable">@filegroup_name</span> <span class="token operator">=</span> N<span class="token string">&#39;CDCFG&#39;</span><span class="token punctuation">;</span>  
GO  

<span class="token comment">/* 执行结果
消息
作业 &#39;cdc.AdventureWorks2016_capture&#39; 已成功启动。
作业 &#39;cdc.AdventureWorks2016_cleanup&#39; 已成功启动。
*/</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当对表启用变更数据捕获成功之后会修改或创建以下内容：</p><h3 id="_3-2-1-捕获实例" tabindex="-1"><a class="header-anchor" href="#_3-2-1-捕获实例"><span>3.2.1 捕获实例</span></a></h3><p>创建一个捕获实例，可以使用 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_help_change_data_capture<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>存储过程来检索此信息。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 返回 HumanResources.Department 表的变更数据捕获实例配置。</span>
<span class="token keyword">EXECUTE</span> sys<span class="token punctuation">.</span>sp_cdc_help_change_data_capture   
    <span class="token variable">@source_schema</span> <span class="token operator">=</span> N<span class="token string">&#39;HumanResources&#39;</span><span class="token punctuation">,</span>   
    <span class="token variable">@source_name</span> <span class="token operator">=</span> N<span class="token string">&#39;Department&#39;</span><span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 返回 所有启用表的变更数据捕获实例配置。</span>
<span class="token keyword">EXECUTE</span> sys<span class="token punctuation">.</span>sp_cdc_help_change_data_capture<span class="token punctuation">;</span>  
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-2-2-sys-tables视图" tabindex="-1"><a class="header-anchor" href="#_3-2-2-sys-tables视图"><span>3.2.2 <code>sys.tables</code>视图</span></a></h3><p>更新<code>sys.tables</code>视图的表条目中的<code>is_tracked_by_cdc</code> 列为1.</p><h3 id="_3-2-3-更改表" tabindex="-1"><a class="header-anchor" href="#_3-2-3-更改表"><span>3.2.3 更改表</span></a></h3><p>创建更改表<code>cdc.HumanResources_Department_CT</code>，</p><p>变更表是关联<code>捕获实例</code>的，命名方式为：&lt;捕获实例名称&gt;_CT。</p><p><img src="/document/images/sqlserver-cdc/3CE944AD.png" alt=""></p><h3 id="_3-2-4-查询函数" tabindex="-1"><a class="header-anchor" href="#_3-2-4-查询函数"><span>3.2.4 查询函数</span></a></h3><p>创建查询函数</p><ul><li><p>查询所有更改函数：<code>cdc.fn_cdc_get_all_changes_HumanResources_Department</code></p><p>命名方式为：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-functions/cdc-fn-cdc-get-all-changes-capture-instance-transact-sql?view=sql-server-ver15#examples" target="_blank" rel="noopener noreferrer">cdc.fn_cdc_get_all_changes_&lt;捕获实例名称&gt;<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>​ 返回指定的时间间隔内出现的所有更改表项。</p></li><li><p>查询Net changes（净更改函数） 函数：<code>cdc.fn_cdc_get_net_changes_HumanResources_Department</code></p><p>​ 命名方式为：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-functions/cdc-fn-cdc-get-net-changes-capture-instance-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.fn_cdc_get_net_changes_&lt;捕获实例名称&gt;<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>​ Net changes 函数的创建取决于<code>捕获示例</code>新建时的<code>supports_net_changes</code>属性。</p><p>​ 返回指定的时间间隔内发生更改的每个非重复行，此函数仅返回一项更改</p></li></ul><p><img src="/document/images/sqlserver-cdc/89548E8B.png" alt=""></p><h3 id="_3-2-5-元数据表" tabindex="-1"><a class="header-anchor" href="#_3-2-5-元数据表"><span>3.2.5 元数据表</span></a></h3><p>在<strong>cdc.change_tables</strong>，<strong>cdc.index_columns</strong>，<strong>cdc.captured_columns</strong> 元数据表中插入信息。</p><h3 id="_3-2-6-代理作业" tabindex="-1"><a class="header-anchor" href="#_3-2-6-代理作业"><span>3.2.6 代理作业</span></a></h3><p>首次启动表启用变更数据捕获时，会创建两个关联数据库的SQL Server代理作业。捕获和清除作业都是使用默认参数创建的。</p><p>​ <img src="/document/images/sqlserver-cdc/D874E031.png" alt=""></p><ul><li><p>捕获更改表作业（capture）</p><p>捕获作业会立即启动。 它连续运行，每个扫描周期最多可处理 1000 个事务，并在两个周期之间停顿 5 秒钟。</p></li><li><p>清除更改表作业（cleanup）</p><p>清除作业在每天凌晨 2 点运行一次。 它将更改表项保留三天（4320 分钟），使用单个删除语句最多可删除 5000 项。</p></li></ul><p>修改作业：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-change-job-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_change_job<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 修改捕获作业</span>
<span class="token keyword">EXECUTE</span> sys<span class="token punctuation">.</span>sp_cdc_change_job   
    <span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;capture&#39;</span><span class="token punctuation">,</span>  <span class="token comment">-- 作业的类型</span>
    <span class="token variable">@maxscans</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span>  <span class="token comment">-- 从日志中提取所有行而要执行的扫描周期的最大数目</span>
    <span class="token variable">@maxtrans</span> <span class="token operator">=</span> <span class="token number">15</span>，  <span class="token comment">-- 每个扫描循环中要处理的最大事务数</span>
    <span class="token variable">@pollinginterval</span> <span class="token operator">=</span> <span class="token number">5</span>， <span class="token comment">-- 扫描间隔（秒）</span>
    <span class="token variable">@continuous</span> <span class="token operator">=</span> <span class="token number">1</span>； <span class="token comment">-- 1循环运行，0只运行一次</span>
GO  
<span class="token comment">-- 修改清楚作业</span>
<span class="token keyword">EXECUTE</span> sys<span class="token punctuation">.</span>sp_cdc_change_job   
    <span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;cleanup&#39;</span><span class="token punctuation">,</span> <span class="token comment">-- 作业的类型</span>
    <span class="token variable">@retention</span> <span class="token operator">=</span> <span class="token number">2880</span><span class="token punctuation">;</span>  <span class="token comment">-- 更改行要在更改表中保留的分钟数</span>
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查询作业：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-jobs-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_help_jobs <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>或直接查询<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/dbo-cdc-jobs-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">dbo.cdc_jobs<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 表</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 查询作业.</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_help_jobs<span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>启动作业：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-start-job-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_start_job<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2012<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 启动捕获作业，可以不指定 job_type 的值，因为默认作业类型为 &quot; 捕获&quot;。</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_start_job
	<span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;capture&#39;</span><span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 启动清除作业。</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_start_job 
	<span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;cleanup&#39;</span><span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>停止作业：<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-stop-job-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_stop_job<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2012<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 停止捕获作业。</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_stop_job <span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;capture&#39;</span><span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 停止清除作业。</span>
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_stop_job <span class="token variable">@job_type</span> <span class="token operator">=</span> N<span class="token string">&#39;cleanup&#39;</span><span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意</p><p>修改作业后，需要重启作业后才会生效。</p><p>启动和停止捕获作业并不会造成更改数据丢失。 可以在高峰需求时段禁止扫描日志以免增加负载。</p><p>数据库引擎服务或 SQL Server 代理服务在 NETWORK SERVICE 帐户下运行时，变更数据捕获无法正常工作。 这可能导致错误 22832。</p></blockquote><h2 id="_3-3-禁用数据库变更数据捕获-cdc" tabindex="-1"><a class="header-anchor" href="#_3-3-禁用数据库变更数据捕获-cdc"><span>3.3 禁用数据库变更数据捕获(CDC)</span></a></h2><p>数据库禁用变更数据捕获，将同时删除所有关联的变更数据捕获元数据（括 <strong>cdc</strong> 用户、架构和变更数据捕获作业）。所以不必先禁用各个表。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 禁用数据库变更数据捕获</span>
<span class="token keyword">USE</span> AdventureWorks2016  
GO  
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_disable_db  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-4-禁用表变更数据捕获" tabindex="-1"><a class="header-anchor" href="#_3-4-禁用表变更数据捕获"><span>3.4 禁用表变更数据捕获</span></a></h2><ul><li>如果删除了启用变更数据捕获的表，则会自动删除与该表关联的变更数据捕获元数据。</li><li>如果在禁用发生后没有对数据库启用任何表，则还会删除变更数据捕获作业。</li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> AdventureWorks2016  
GO  
<span class="token keyword">EXEC</span> sys<span class="token punctuation">.</span>sp_cdc_disable_table  
<span class="token variable">@source_schema</span> <span class="token operator">=</span> N<span class="token string">&#39;dbo&#39;</span><span class="token punctuation">,</span>  
<span class="token variable">@source_name</span>   <span class="token operator">=</span> N<span class="token string">&#39;MyTable&#39;</span><span class="token punctuation">,</span>  
<span class="token variable">@capture_instance</span> <span class="token operator">=</span> N<span class="token string">&#39;dbo_MyTable&#39;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-5-监视cdc状态" tabindex="-1"><a class="header-anchor" href="#_3-5-监视cdc状态"><span>3.5 监视CDC状态</span></a></h2><ul><li><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/change-data-capture-sys-dm-cdc-log-scan-sessions?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.dm_cdc_log_scan_sessions<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>自 SQL Server 服务最后一次启动以来，日志扫描会话的状态信息。每个日志扫描会话记录一行，最后一行表示当前会话。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> session_id<span class="token punctuation">,</span> start_time<span class="token punctuation">,</span> end_time<span class="token punctuation">,</span> duration<span class="token punctuation">,</span> scan_phase<span class="token punctuation">,</span>  
    error_count<span class="token punctuation">,</span> start_lsn<span class="token punctuation">,</span> current_lsn<span class="token punctuation">,</span> end_lsn<span class="token punctuation">,</span> tran_count<span class="token punctuation">,</span>  
    last_commit_lsn<span class="token punctuation">,</span> last_commit_time<span class="token punctuation">,</span> log_record_count<span class="token punctuation">,</span> schema_change_count<span class="token punctuation">,</span>  
    command_count<span class="token punctuation">,</span> first_begin_cdc_lsn<span class="token punctuation">,</span> last_commit_cdc_lsn<span class="token punctuation">,</span>   
    last_commit_cdc_time<span class="token punctuation">,</span> latency<span class="token punctuation">,</span> empty_scan_count<span class="token punctuation">,</span> failed_sessions_count  
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_cdc_log_scan_sessions  
<span class="token keyword">WHERE</span> session_id <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">MAX</span><span class="token punctuation">(</span>b<span class="token punctuation">.</span>session_id<span class="token punctuation">)</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_cdc_log_scan_sessions <span class="token keyword">AS</span> b<span class="token punctuation">)</span><span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/change-data-capture-sys-dm-cdc-errors?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.dm_cdc_errors<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>变更数据捕获日志扫描会话中遇到的每个错误返回一行。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_cdc_errors
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ul><h1 id="_4-扩展" tabindex="-1"><a class="header-anchor" href="#_4-扩展"><span>4 扩展</span></a></h1><h2 id="_4-1-元数据表" tabindex="-1"><a class="header-anchor" href="#_4-1-元数据表"><span>4.1 元数据表</span></a></h2><h3 id="cdc-change-tables" tabindex="-1"><a class="header-anchor" href="#cdc-change-tables"><span><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/cdc-change-tables-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.change_tables<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h3><p>为数据库中的每个更改表返回一行。 对源表启用变更数据捕获时，将创建一个更改表。</p><p>不要直接<strong>查询系统表cdc.change_tables</strong>， 请改为执行 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_help_change_data_capture<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 存储过程。</p><table><thead><tr><th><strong>cdc.change_tables</strong>（部分列）</th><th></th><th></th></tr></thead><tbody><tr><td><strong>列名称</strong></td><td><strong>数据类型</strong></td><td><strong>说明</strong></td></tr><tr><td>object_id</td><td>int</td><td>更改表的 ID。在数据库中是唯一的。</td></tr><tr><td>source_object_id</td><td>int</td><td>更改表的源表的 ID。</td></tr><tr><td>capture_instance</td><td>sysname</td><td>用于命名特定于实例的跟踪对象的捕获实例的名称。 默认情况下，该名称从源架构名称加上源表名称派生，格式 <em>schemaname_sourcename</em>。</td></tr><tr><td>has_drop_pending</td><td>bit</td><td>捕获进程收到关于源表已被删除的通知。</td></tr><tr><td>filegroup_name</td><td>sysname</td><td>更改表所驻留的文件组的名称。NULL = 更改表在数据库的默认文件组中。</td></tr><tr><td>create_date</td><td>datetime</td><td>启用源表的日期。</td></tr><tr><td>partition_switch</td><td>bit</td><td>指示是否可以对启用了变更数据捕获的表执行 <strong>ALTER TABLE</strong> 的 <strong>SWITCH PARTITION</strong> 命令。 0 指示分区切换被阻止。 未分区表始终返回 1。</td></tr></tbody></table><h3 id="cdc-captured-columns" tabindex="-1"><a class="header-anchor" href="#cdc-captured-columns"><span><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/cdc-captured-columns-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.captured_columns<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h3><p><strong>为在捕获实例中跟踪的每一列返回一行。</strong> 默认情况下，为捕获源表中的所有列。</p><p>不要 <strong>直接查询系统表cdc.captured_columns</strong>。 请改为执行 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-captured-columns-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_get_source_columns<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 存储过程。</p><table><thead><tr><th><strong>cdc.captured_columns</strong></th><th></th><th></th></tr></thead><tbody><tr><td><strong>列名称</strong></td><td><strong>数据类型</strong></td><td><strong>说明</strong></td></tr><tr><td>object_id</td><td>int</td><td>捕获的列所属的更改表的 ID。</td></tr><tr><td>column_name</td><td>sysname</td><td>捕获的列的名称。</td></tr><tr><td>column_id</td><td>int</td><td>捕获的列在源表内的 ID。</td></tr><tr><td>column_type</td><td>sysname</td><td>捕获的列的类型。</td></tr><tr><td>column_ordinal</td><td>int</td><td>更改表中的列序号（从 1 开始）。 将排除更改表中的元数据列。 序号 1 将分配给捕获到的第一个列。</td></tr><tr><td>is_computed</td><td>bit</td><td>表示捕获到的列是源表中计算所得的列。</td></tr></tbody></table><h3 id="cdc-ddl-history" tabindex="-1"><a class="header-anchor" href="#cdc-ddl-history"><span><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/cdc-ddl-history-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.ddl_history<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h3><p><strong>为对启用了变更数据捕获的表所做的每一项数据定义语言 (DDL) 更改返回一行</strong>。 可以使用此表来确定源表发生 DDL 更改的时间以及更改的内容。 此表中不包含未发生 DDL 更改的源表的任何条目。</p><p>不要<strong>直接查询系统表cdc.ddl_history</strong>， 请改为执行 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-get-ddl-history-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_get_ddl_history<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 存储过程。</p><table><thead><tr><th style="text-align:left;">cdc.ddl_history</th><th style="text-align:left;"></th><th style="text-align:left;"></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>列名称</strong></td><td style="text-align:left;"><strong>数据类型</strong></td><td style="text-align:left;"><strong>说明</strong></td></tr><tr><td style="text-align:left;">source_object_id</td><td style="text-align:left;">int</td><td style="text-align:left;">应用 DDL 更改的源表的 ID。</td></tr><tr><td style="text-align:left;">object_id</td><td style="text-align:left;">int</td><td style="text-align:left;">与源表的捕获实例相关联的更改表的 ID。</td></tr><tr><td style="text-align:left;">required_column_update</td><td style="text-align:left;">bit</td><td style="text-align:left;">指示在源表中修改了捕获列的数据类型。 此修改改变了更改表中的列。</td></tr><tr><td style="text-align:left;">ddl_command</td><td style="text-align:left;">nvarchar(max)</td><td style="text-align:left;">应用于源表的 DDL 语句。</td></tr><tr><td style="text-align:left;">ddl_lsn</td><td style="text-align:left;">binary(10)</td><td style="text-align:left;">与 DDL 修改的提交相关联的日志序列号 (LSN)。</td></tr><tr><td style="text-align:left;">ddl_time</td><td style="text-align:left;">datetime</td><td style="text-align:left;">对源表所做的 DDL 更改的日期和时间。</td></tr></tbody></table><h3 id="cdc-index-columns" tabindex="-1"><a class="header-anchor" href="#cdc-index-columns"><span><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/cdc-index-columns-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.index_columns<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h3><p><strong>为与更改表关联的每个索引列返回一行。变更数据捕获使用这些索引列来唯一标识源表中的行。</strong></p><p>默认情况下，将包括源表的主键列。 但是，如果在对源表启用变更数据捕获时指定了源表的唯一索引，则将改用该索引中的列。 如果启用净更改跟踪，则该源表需要主键或唯一索引。</p><p>不要直接查询系统表， 请改为执行 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sys-sp-cdc-help-change-data-capture-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.sp_cdc_help_change_data_capture<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 存储过程。</p><table><thead><tr><th style="text-align:left;">cdc.index_columns</th><th style="text-align:left;"></th><th style="text-align:left;"></th></tr></thead><tbody><tr><td style="text-align:left;"><strong>列名称</strong></td><td style="text-align:left;"><strong>数据类型</strong></td><td style="text-align:left;"><strong>说明</strong></td></tr><tr><td style="text-align:left;">object_id</td><td style="text-align:left;">int</td><td style="text-align:left;">更改表的 ID。</td></tr><tr><td style="text-align:left;">column_name</td><td style="text-align:left;">sysname</td><td style="text-align:left;">索引列的名称。</td></tr><tr><td style="text-align:left;">index_ordinal</td><td style="text-align:left;">tinyint</td><td style="text-align:left;">索引中的列序号（从 1 开始）。</td></tr><tr><td style="text-align:left;">column_id</td><td style="text-align:left;">int</td><td style="text-align:left;">源表中的列 ID。</td></tr></tbody></table><h3 id="cdc-lsn-time-mapping" tabindex="-1"><a class="header-anchor" href="#cdc-lsn-time-mapping"><span><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-tables/cdc-lsn-time-mapping-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">cdc.lsn_time_mapping<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></span></a></h3><p><strong>为每个在更改表中存在行的事务返回一行。</strong></p><p>该表用于在日志序列号 (LSN) 提交值和提交事务的时间之间建立映射。 没有对应的更改表项的项也可以记录下来， 以便表在变更活动少或者无变更活动期间将 LSN 处理的完成过程记录下来。</p><p>不要直接查询系统表， 请改为执行</p><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-functions/sys-fn-cdc-map-lsn-to-time-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.fn_cdc_map_lsn_to_time (transact-sql)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 或 <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-functions/sys-fn-cdc-map-time-to-lsn-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.fn_cdc_map_time_to_lsn (transact-sql)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 系统函数。</p><table><thead><tr><th style="text-align:left;">cdc.lsn_time_mapping</th><th style="text-align:left;"></th><th style="text-align:left;"></th></tr></thead><tbody><tr><td style="text-align:left;">列名称</td><td style="text-align:left;">数据类型</td><td style="text-align:left;">说明</td></tr><tr><td style="text-align:left;">start_lsn</td><td style="text-align:left;">binary(10)</td><td style="text-align:left;">提交的事务的 LSN。</td></tr><tr><td style="text-align:left;">tran_begin_time</td><td style="text-align:left;">datetime</td><td style="text-align:left;">与 LSN 关联的事务开始的时间。</td></tr><tr><td style="text-align:left;">tran_end_time</td><td style="text-align:left;">datetime</td><td style="text-align:left;">事务结束的时间。</td></tr><tr><td style="text-align:left;">tran_id</td><td style="text-align:left;">varbinary (10)</td><td style="text-align:left;">事务的 ID。</td></tr></tbody></table><h3 id="systranschemas" tabindex="-1"><a class="header-anchor" href="#systranschemas"><span>systranschemas</span></a></h3><p><strong>Systranschemas</strong> 表用于跟踪事务发布和快照发布中发布的项目中的架构更改。 此表存储在发布数据库和订阅数据库中</p><table><thead><tr><th style="text-align:left;">systranschemas</th><th style="text-align:left;"></th><th style="text-align:left;"></th></tr></thead><tbody><tr><td style="text-align:left;">列名称</td><td style="text-align:left;">数据类型</td><td style="text-align:left;">说明</td></tr><tr><td style="text-align:left;">tabid</td><td style="text-align:left;">int</td><td style="text-align:left;">标识发生了架构更改的表项目。</td></tr><tr><td style="text-align:left;">startlsn 时发生</td><td style="text-align:left;">binary</td><td style="text-align:left;">架构更改开始时的 LSN 值。</td></tr><tr><td style="text-align:left;">endlsn</td><td style="text-align:left;">binary</td><td style="text-align:left;">架构更改结束时的 LSN 值。</td></tr><tr><td style="text-align:left;">typeid</td><td style="text-align:left;">int</td><td style="text-align:left;">架构更改的类型。</td></tr></tbody></table><h3 id="更改表-xxxx-ct" tabindex="-1"><a class="header-anchor" href="#更改表-xxxx-ct"><span>更改表（xxxx_CT）</span></a></h3><p><strong>更改表充当捕获进程从事务日志中提取的源表更改的存储库。</strong></p><p>变更数据捕获更改表的前五列是元数据列。 这些列提供与记录的更改有关的附加信息。 其余列镜像源表中按名称标识的捕获列（通常还会按类型进行标识）。 这些列保存从源表中收集的捕获列数据。</p><p>例如：</p><p><img src="/document/images/sqlserver-cdc/6F740C70.png" alt=""></p><table><thead><tr><th style="text-align:left;">systranschemas</th><th style="text-align:left;"></th><th style="text-align:left;"></th></tr></thead><tbody><tr><td style="text-align:left;">列名称</td><td style="text-align:left;">数据类型</td><td style="text-align:left;">说明</td></tr><tr><td style="text-align:left;">__$start_lsn</td><td style="text-align:left;">binary</td><td style="text-align:left;">更改指定的提交日志序列号 (LSN)。提交 LSN 不仅标识在同一事务中提交的更改，而且还对这些事务进行排序。</td></tr><tr><td style="text-align:left;">__$end_lsn</td><td style="text-align:left;">binary</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">__$seqval</td><td style="text-align:left;">binary</td><td style="text-align:left;">同一事务中进行的更改排序</td></tr><tr><td style="text-align:left;">__$operation</td><td style="text-align:left;">int</td><td style="text-align:left;">更改相关的操作：1 = 删除、2 = 插入、3 = 更新（前映象）、4 = 更新（后映像）。</td></tr><tr><td style="text-align:left;">__$update_mask</td><td style="text-align:left;">varbinary</td><td style="text-align:left;">一个可变的位掩码，每个捕获列都有一个对应的定义位。 对于插入和删除项，更新掩码始终设定所有位。 但是，更新行仅设定与更改列对应的那些位</td></tr><tr><td style="text-align:left;">捕获源表的列...</td><td style="text-align:left;">...</td><td style="text-align:left;">...</td></tr></tbody></table><h2 id="_4-2-数据定义语言-ddl" tabindex="-1"><a class="header-anchor" href="#_4-2-数据定义语言-ddl"><span>4.2 数据定义语言（DDL）</span></a></h2><p><strong>SQL语言集中负责数据结构定义与数据库对象定义的语言，由CREATE、ALTER与DROP三个语法所组成。</strong></p><ul><li>CREATE DATABASE</li><li>ALTER DATABASE</li><li>CREATE TABLE</li><li>ALTER TABLE</li><li>CREATE INDEX</li><li>DROP INDEX</li><li>...</li></ul><h2 id="_4-3-数据操纵语言-dml" tabindex="-1"><a class="header-anchor" href="#_4-3-数据操纵语言-dml"><span>4.3 数据操纵语言（DML)</span></a></h2><p>​ INSERT、UPDATE、DELETE三种指令。</p><h2 id="_4-4-捕获实例" tabindex="-1"><a class="header-anchor" href="#_4-4-捕获实例"><span>4.4 捕获实例</span></a></h2><ul><li><p>在为源表启用变更数据捕获后，会忽略源表的任何新列。 如果删除了某个跟踪的列，则会为在后续更改项中为该列提供 Null 值。但是，如果源表列的数据类型发生了更改，则这种更改会传播到更改表中。</p></li><li><p>可同时与单个源表相关联的最大捕获实例数为两个。</p></li></ul></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/fschenzihao/document/edit/master/docs/sql-server/sqlserver-cdc.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页"><!--[--><!--]--> 编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次编辑于: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/document/assets/app-CUvyzFzm.js" defer></script>
  </body>
</html>
