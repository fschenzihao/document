<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.8" />
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html,
      body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia('(prefers-color-scheme: dark)').matches
      if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
        document.documentElement.classList.toggle('dark', true)
      }
    </script>
    <title>SQL Server 性能分析 | Document</title><meta name="description" content="">
    <link rel="preload" href="/document/assets/style-6ANAoVcY.css" as="style"><link rel="stylesheet" href="/document/assets/style-6ANAoVcY.css">
    <link rel="modulepreload" href="/document/assets/app-CUvyzFzm.js"><link rel="modulepreload" href="/document/assets/sqlserver-performance-analysis.html-BAMe6NRZ.js">
    <link rel="prefetch" href="/document/assets/index.html-i1lWAYOx.js" as="script"><link rel="prefetch" href="/document/assets/javascript-cookbook.html-D_V7sQEA.js" as="script"><link rel="prefetch" href="/document/assets/typescript-cookbook.html-CYReqr7Y.js" as="script"><link rel="prefetch" href="/document/assets/cefsharp-cookbook.html-B_-KPTPf.js" as="script"><link rel="prefetch" href="/document/assets/make-thread-safe-calls-to-windows-forms-controls.html-DMx8RPcX.js" as="script"><link rel="prefetch" href="/document/assets/dottrace.html-B-udI0tq.js" as="script"><link rel="prefetch" href="/document/assets/git-cookbook.html-uP5BoEOf.js" as="script"><link rel="prefetch" href="/document/assets/gitblit-cookbook.html-CX-d2Nvj.js" as="script"><link rel="prefetch" href="/document/assets/javascript-cookbook.html-BXfQ0ob6.js" as="script"><link rel="prefetch" href="/document/assets/typescript-cookbook.html-BYA97-NX.js" as="script"><link rel="prefetch" href="/document/assets/how-to-write-a-typescript-library.html-BmBvv7O7.js" as="script"><link rel="prefetch" href="/document/assets/npm-cookbook.html-BqhLPphN.js" as="script"><link rel="prefetch" href="/document/assets/package-manager-configuration.html-sBY_PEBO.js" as="script"><link rel="prefetch" href="/document/assets/package.json-manual.html-BVxbY97E.js" as="script"><link rel="prefetch" href="/document/assets/vite-cookbook.html-CVDvA-KP.js" as="script"><link rel="prefetch" href="/document/assets/vue-cookbook.html-BHoLgx8w.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-cdc.html-CSIHN8YG.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-common-functions.html-DU53Dppu.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-performance-analysis-query-satas.html-B7Qq3hDK.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-profiler.html-DBE4uks0.js" as="script"><link rel="prefetch" href="/document/assets/sqlserver-repair-database.html-KZx0wrnO.js" as="script"><link rel="prefetch" href="/document/assets/windows-server-performance-analysis.html-gq2rq8-j.js" as="script"><link rel="prefetch" href="/document/assets/404.html-oMcT5ubu.js" as="script"><link rel="prefetch" href="/document/assets/style-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/document/assets/docsearch-l0sNRNKZ.js" as="script"><link rel="prefetch" href="/document/assets/index-DiZEX-Ml.js" as="script"><link rel="prefetch" href="/document/assets/mermaid.core-xoE18cY4.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/document/"><img class="logo" src="/document/images/logo/logo.png" alt="Document"><span class="site-name can-hide" aria-hidden="true">Document</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/document/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/fschenzihao/document/commits/master" rel="noopener noreferrer" target="_blank" aria-label="更新日志"><!--[--><!--]--> 更新日志 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/fschenzihao/document" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!--[--><div id="docsearch-container" style="display:none;"></div><div><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索文档"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索文档</span></span><span class="DocSearch-Button-Keys"><kbd class="DocSearch-Button-Key"><svg width="15" height="15" class="DocSearch-Control-Key-Icon"><path d="M4.505 4.496h2M5.505 5.496v5M8.216 4.496l.055 5.993M10 7.5c.333.333.5.667.5 1v2M12.326 4.5v5.996M8.384 4.496c1.674 0 2.116 0 2.116 1.5s-.442 1.5-2.116 1.5M3.205 9.303c-.09.448-.277 1.21-1.241 1.203C1 10.5.5 9.513.5 8V7c0-1.57.5-2.5 1.464-2.494.964.006 1.134.598 1.24 1.342M12.553 10.5h1.953" stroke-width="1.2" stroke="currentColor" fill="none" stroke-linecap="square"></path></svg></kbd><kbd class="DocSearch-Button-Key">K</kbd></span></button></div><!--]--></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items" aria-label="site navigation"><!--[--><div class="navbar-item"><a class="route-link" href="/document/" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="0.0.4"><span class="title">0.0.4</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a class="external-link" href="https://github.com/fschenzihao/document/commits/master" rel="noopener noreferrer" target="_blank" aria-label="更新日志"><!--[--><!--]--> 更新日志 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/fschenzihao/document" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">SQL Server 性能分析 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_1-索引" aria-label="1 索引"><!--[--><!--]--> 1 索引 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_1-1-查询索引的情况" aria-label="1.1. 查询索引的情况"><!--[--><!--]--> 1.1. 查询索引的情况 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_1-2-重新生成或重新组织索引" aria-label="1.2. 重新生成或重新组织索引"><!--[--><!--]--> 1.2. 重新生成或重新组织索引 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_1-3-查找缺失索引组的缺失索引及其列详细信息" aria-label="1.3. 查找缺失索引组的缺失索引及其列详细信息"><!--[--><!--]--> 1.3. 查找缺失索引组的缺失索引及其列详细信息 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_1-4-指定索引的填充因子" aria-label="1.4 指定索引的填充因子"><!--[--><!--]--> 1.4 指定索引的填充因子 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_1-5-查询表的所有索引和索引列" aria-label="1.5 查询表的所有索引和索引列"><!--[--><!--]--> 1.5 查询表的所有索引和索引列 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_1-6-查询索引使用统计" aria-label="1.6 查询索引使用统计"><!--[--><!--]--> 1.6 查询索引使用统计 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_2-数据库文件和文件组" aria-label="2 数据库文件和文件组"><!--[--><!--]--> 2 数据库文件和文件组 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_2-1-数据库文件" aria-label="2.1 数据库文件"><!--[--><!--]--> 2.1 数据库文件 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_2-2-文件组" aria-label="2.2 文件组"><!--[--><!--]--> 2.2 文件组 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_2-3-添加文件和文件组" aria-label="2.3 添加文件和文件组"><!--[--><!--]--> 2.3 添加文件和文件组 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_2-4-移动文件" aria-label="2.4 移动文件"><!--[--><!--]--> 2.4 移动文件 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_3-日志文件" aria-label="3 日志文件"><!--[--><!--]--> 3 日志文件 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_3-1-收缩日志" aria-label="3.1 收缩日志"><!--[--><!--]--> 3.1 收缩日志 <!--[--><!--]--></a><!----></li><li><a class="route-link sidebar-item" href="/document/#_3-2-日志无法收缩的部分解决办法" aria-label="3.2 日志无法收缩的部分解决办法"><!--[--><!--]--> 3.2 日志无法收缩的部分解决办法 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_4-执行计划" aria-label="4 执行计划"><!--[--><!--]--> 4 执行计划 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_4-1-清除计划缓存" aria-label="4.1  清除计划缓存"><!--[--><!--]--> 4.1  清除计划缓存 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a class="route-link sidebar-item" href="/document/#_5-系统信息" aria-label="5 系统信息"><!--[--><!--]--> 5 系统信息 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a class="route-link sidebar-item" href="/document/#_5-1-查询sql-server启动时间" aria-label="5.1 查询SQL Server启动时间"><!--[--><!--]--> 5.1 查询SQL Server启动时间 <!--[--><!--]--></a><!----></li><!--]--></ul></li><!--]--></ul></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="sql-server-性能分析" tabindex="-1"><a class="header-anchor" href="#sql-server-性能分析"><span>SQL Server 性能分析</span></a></h1><h2 id="_1-索引" tabindex="-1"><a class="header-anchor" href="#_1-索引"><span>1 索引</span></a></h2><p>索引的碎片率高或索引缺失都有可能造成SQL Server引擎的CPU使用率高。</p><h3 id="_1-1-查询索引的情况" tabindex="-1"><a class="header-anchor" href="#_1-1-查询索引的情况"><span>1.1. 查询索引的情况</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> <span class="token punctuation">[</span>输入数据库名<span class="token punctuation">]</span>

<span class="token keyword">declare</span> <span class="token variable">@database_id</span> <span class="token keyword">smallint</span><span class="token punctuation">,</span>
		<span class="token variable">@table_id</span> <span class="token keyword">int</span><span class="token punctuation">,</span>
		<span class="token variable">@mode</span> nvarchar<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>
        
<span class="token comment">--*** 输入参数 ***--</span>

<span class="token keyword">set</span> <span class="token variable">@database_id</span> <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">&#39;指定数据库名或空字符串&#39;</span><span class="token punctuation">)</span> 	<span class="token comment">-- 指定数据库名或空字符串。</span>
<span class="token keyword">set</span> <span class="token variable">@table_id</span> <span class="token operator">=</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> 	<span class="token comment">-- 指定表名，空字符串则为所有表。</span>
<span class="token keyword">set</span> <span class="token variable">@mode</span> <span class="token operator">=</span> <span class="token string">&#39;SAMPLED&#39;</span> 	<span class="token comment">-- 获取统计信息的扫描级别: LIMITED(轻量), SAMPLED（抽样）, DETAILED（详细）</span>

<span class="token comment">--*** 输入参数 ***--</span>

<span class="token keyword">select</span> 
	DB_NAME<span class="token punctuation">(</span>d<span class="token punctuation">.</span>database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库<span class="token punctuation">]</span><span class="token punctuation">,</span>
	OBJECT_NAME<span class="token punctuation">(</span>d<span class="token punctuation">.</span>object_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>表<span class="token punctuation">]</span><span class="token punctuation">,</span>
    i<span class="token punctuation">.</span>name <span class="token keyword">as</span> <span class="token punctuation">[</span>索引名称<span class="token punctuation">]</span><span class="token punctuation">,</span>
	<span class="token keyword">case</span> d<span class="token punctuation">.</span>index_type_desc 
		<span class="token keyword">when</span> <span class="token string">&#39;CLUSTERED INDEX&#39;</span> <span class="token keyword">then</span> <span class="token string">&#39;聚集索引&#39;</span>
		<span class="token keyword">when</span> <span class="token string">&#39;NONCLUSTERED INDEX&#39;</span> <span class="token keyword">then</span> <span class="token string">&#39;非聚集&#39;</span>
		<span class="token keyword">when</span> <span class="token string">&#39;HEAP&#39;</span> <span class="token keyword">then</span> <span class="token string">&#39;堆&#39;</span>
		<span class="token keyword">else</span> d<span class="token punctuation">.</span>index_type_desc <span class="token keyword">end</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>索引类型<span class="token punctuation">]</span><span class="token punctuation">,</span>
    d<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token keyword">as</span> <span class="token punctuation">[</span>碎片<span class="token punctuation">(</span><span class="token operator">%</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    d<span class="token punctuation">.</span>avg_page_space_used_in_percent <span class="token keyword">as</span> <span class="token punctuation">[</span>平均页面密度<span class="token punctuation">(</span><span class="token operator">%</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    i<span class="token punctuation">.</span>fill_factor <span class="token keyword">as</span> <span class="token punctuation">[</span>填充因子<span class="token punctuation">]</span>
<span class="token keyword">from</span> 
sys<span class="token punctuation">.</span>dm_db_index_physical_stats<span class="token punctuation">(</span> <span class="token variable">@database_id</span><span class="token punctuation">,</span> <span class="token variable">@table_id</span><span class="token punctuation">,</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token keyword">DEFAULT</span><span class="token punctuation">,</span> <span class="token variable">@mode</span><span class="token punctuation">)</span> d
       <span class="token keyword">left</span> <span class="token keyword">join</span> sys<span class="token punctuation">.</span>indexes i <span class="token keyword">on</span> 
              i<span class="token punctuation">.</span>object_id <span class="token operator">=</span> d<span class="token punctuation">.</span>object_id <span class="token operator">and</span> 
              i<span class="token punctuation">.</span>index_id <span class="token operator">=</span> d<span class="token punctuation">.</span>index_id
<span class="token keyword">where</span> d<span class="token punctuation">.</span>index_id <span class="token operator">&gt;</span> <span class="token number">0</span>
<span class="token keyword">order</span> <span class="token keyword">by</span> d<span class="token punctuation">.</span>avg_fragmentation_in_percent <span class="token keyword">desc</span><span class="token punctuation">,</span> d<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span> d<span class="token punctuation">.</span>database_id

GO

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行结果</strong></p><p><img src="/document/images/sqlserver-performance-analysis/indexinformation.jpg" alt="执行结果" title="索引情况.png"></p><h3 id="_1-2-重新生成或重新组织索引" tabindex="-1"><a class="header-anchor" href="#_1-2-重新生成或重新组织索引"><span>1.2. 重新生成或重新组织索引</span></a></h3><div class="custom-container warning"><p class="custom-container-title">注意</p><ul><li>重新生成或重新组织小型行存储索引可能不会减少碎片。</li><li>收缩数据库后，可能产生索引碎片。</li></ul></div><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 以下示例将自动重新组织或重新生成数据库中平均碎片超过 10％ 的所有分区。</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@fragment</span> <span class="token keyword">float</span><span class="token punctuation">,</span>
		<span class="token variable">@database_id</span> <span class="token keyword">smallint</span><span class="token punctuation">,</span>
    <span class="token variable">@dataBase_name</span> nvarchar<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span>

<span class="token comment">/********请先修改参数***********
 *↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓*/</span>

<span class="token keyword">USE</span> <span class="token punctuation">[</span>这里写数据库名称<span class="token punctuation">]</span>  <span class="token comment">-- 这里写数据库名称</span>
<span class="token keyword">set</span> <span class="token variable">@dataBase_name</span> <span class="token operator">=</span> <span class="token string">&#39;这里写数据库名称&#39;</span> <span class="token comment">-- 这里写数据库名称</span>
<span class="token keyword">set</span> <span class="token variable">@fragment</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token comment">-- 碎片百分比，大于此数值的索引将执行重建。</span>

<span class="token comment">/*↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑↑*
*********** 请先修改参数******/</span>

<span class="token keyword">set</span> <span class="token variable">@database_id</span> <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token variable">@dataBase_name</span><span class="token punctuation">)</span>
<span class="token keyword">IF</span> <span class="token variable">@database_id</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token operator">or</span> <span class="token variable">@database_id</span> <span class="token operator">is</span> <span class="token boolean">null</span>
<span class="token keyword">BEGIN</span>
	<span class="token keyword">PRINT</span> <span class="token string">&#39;执行失败:[@dataBase_name](数据库名称)参数值无效!&#39;</span>
	<span class="token keyword">return</span>
<span class="token keyword">END</span>
 
<span class="token keyword">SET</span> NOCOUNT <span class="token keyword">ON</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@tagid</span> <span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token keyword">DECLARE</span> <span class="token variable">@objectid</span> <span class="token keyword">int</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@indexid</span> <span class="token keyword">int</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@partitioncount</span> <span class="token keyword">bigint</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@schemaname</span> nvarchar<span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token keyword">DECLARE</span> <span class="token variable">@objectname</span> nvarchar<span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token keyword">DECLARE</span> <span class="token variable">@indexname</span> nvarchar<span class="token punctuation">(</span><span class="token number">130</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token keyword">DECLARE</span> <span class="token variable">@partitionnum</span> <span class="token keyword">bigint</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@partitions</span> <span class="token keyword">bigint</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@frag</span> <span class="token keyword">float</span><span class="token punctuation">;</span>  
<span class="token keyword">DECLARE</span> <span class="token variable">@command</span> nvarchar<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token keyword">DECLARE</span> <span class="token variable">@indexcount</span> <span class="token keyword">int</span><span class="token punctuation">;</span>
<span class="token comment">-- Conditionally select tables and indexes from the sys.dm_db_index_physical_stats function   </span>
<span class="token comment">-- and convert object and index IDs to names.  </span>
<span class="token keyword">SELECT</span>  
	<span class="token keyword">identity</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> tagid<span class="token punctuation">,</span>
    object_id <span class="token keyword">AS</span> objectid<span class="token punctuation">,</span>  
    index_id <span class="token keyword">AS</span> indexid<span class="token punctuation">,</span>  
    partition_number <span class="token keyword">AS</span> partitionnum<span class="token punctuation">,</span>  
    avg_fragmentation_in_percent <span class="token keyword">AS</span> frag  
<span class="token keyword">INTO</span> <span class="token comment">#work_to_do  </span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_index_physical_stats <span class="token punctuation">(</span><span class="token variable">@database_id</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span> <span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">&#39;LIMITED&#39;</span><span class="token punctuation">)</span>  
<span class="token keyword">WHERE</span> avg_fragmentation_in_percent <span class="token operator">&gt;</span> <span class="token variable">@fragment</span>
	<span class="token operator">AND</span> index_id <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">;</span>  

<span class="token keyword">SELECT</span> <span class="token variable">@indexcount</span> <span class="token operator">=</span> <span class="token function">COUNT</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> 
<span class="token keyword">FROM</span> <span class="token comment">#work_to_do</span>
<span class="token keyword">SET</span> <span class="token variable">@indexcount</span> <span class="token operator">=</span> ISNULL<span class="token punctuation">(</span> <span class="token variable">@indexcount</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span>
<span class="token keyword">PRINT</span> <span class="token string">&#39;待重建索引数：&#39;</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@indexcount</span> <span class="token keyword">as</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">-- Select * From #work_to_do</span>
<span class="token comment">-- Declare the cursor for the list of partitions to be processed.  </span>
<span class="token keyword">DECLARE</span> partitions <span class="token keyword">CURSOR</span> <span class="token keyword">FOR</span> <span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token comment">#work_to_do;  </span>
  
<span class="token comment">-- Open the cursor.  </span>
<span class="token keyword">OPEN</span> partitions<span class="token punctuation">;</span>  
  
<span class="token comment">-- Loop through the partitions.  </span>
<span class="token keyword">WHILE</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">)</span>  
    <span class="token keyword">BEGIN</span><span class="token punctuation">;</span>  
        <span class="token keyword">FETCH</span> <span class="token keyword">NEXT</span>  
           <span class="token keyword">FROM</span> partitions  
           <span class="token keyword">INTO</span> <span class="token variable">@tagid</span><span class="token punctuation">,</span> <span class="token variable">@objectid</span><span class="token punctuation">,</span> <span class="token variable">@indexid</span><span class="token punctuation">,</span> <span class="token variable">@partitionnum</span><span class="token punctuation">,</span> <span class="token variable">@frag</span><span class="token punctuation">;</span>  
        <span class="token keyword">IF</span> @<span class="token variable">@FETCH_STATUS</span> <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token keyword">BREAK</span><span class="token punctuation">;</span>  
        <span class="token keyword">SELECT</span> <span class="token variable">@objectname</span> <span class="token operator">=</span> QUOTENAME<span class="token punctuation">(</span>o<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">@schemaname</span> <span class="token operator">=</span> QUOTENAME<span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span>  
        <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>objects <span class="token keyword">AS</span> o  
        <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>schemas <span class="token keyword">as</span> s <span class="token keyword">ON</span> s<span class="token punctuation">.</span>schema_id <span class="token operator">=</span> o<span class="token punctuation">.</span>schema_id  
        <span class="token keyword">WHERE</span> o<span class="token punctuation">.</span>object_id <span class="token operator">=</span> <span class="token variable">@objectid</span><span class="token punctuation">;</span>  
        <span class="token keyword">SELECT</span> <span class="token variable">@indexname</span> <span class="token operator">=</span> QUOTENAME<span class="token punctuation">(</span>name<span class="token punctuation">)</span>  
        <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>indexes  
        <span class="token keyword">WHERE</span>  object_id <span class="token operator">=</span> <span class="token variable">@objectid</span> <span class="token operator">AND</span> index_id <span class="token operator">=</span> <span class="token variable">@indexid</span><span class="token punctuation">;</span>  
        <span class="token keyword">SELECT</span> <span class="token variable">@partitioncount</span> <span class="token operator">=</span> <span class="token function">count</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>  
        <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>partitions  
        <span class="token keyword">WHERE</span> object_id <span class="token operator">=</span> <span class="token variable">@objectid</span> <span class="token operator">AND</span> index_id <span class="token operator">=</span> <span class="token variable">@indexid</span><span class="token punctuation">;</span>  
  
<span class="token comment">-- 30是在重组和重建之间切换的决策点。  </span>
        <span class="token keyword">IF</span> <span class="token variable">@frag</span> <span class="token operator">&lt;</span> <span class="token number">30.0</span>  
            <span class="token keyword">SET</span> <span class="token variable">@command</span> <span class="token operator">=</span> N<span class="token string">&#39;ALTER INDEX &#39;</span> <span class="token operator">+</span> <span class="token variable">@indexname</span> <span class="token operator">+</span> N<span class="token string">&#39; ON &#39;</span> <span class="token operator">+</span> <span class="token variable">@schemaname</span> <span class="token operator">+</span> N<span class="token string">&#39;.&#39;</span> <span class="token operator">+</span> <span class="token variable">@objectname</span> <span class="token operator">+</span> N<span class="token string">&#39; REORGANIZE&#39;</span><span class="token punctuation">;</span>  
        <span class="token keyword">IF</span> <span class="token variable">@frag</span> <span class="token operator">&gt;=</span> <span class="token number">30.0</span>  
            <span class="token keyword">SET</span> <span class="token variable">@command</span> <span class="token operator">=</span> N<span class="token string">&#39;ALTER INDEX &#39;</span> <span class="token operator">+</span> <span class="token variable">@indexname</span> <span class="token operator">+</span> N<span class="token string">&#39; ON &#39;</span> <span class="token operator">+</span> <span class="token variable">@schemaname</span> <span class="token operator">+</span> N<span class="token string">&#39;.&#39;</span> <span class="token operator">+</span> <span class="token variable">@objectname</span> <span class="token operator">+</span> N<span class="token string">&#39; REBUILD&#39;</span><span class="token punctuation">;</span>  
        <span class="token keyword">IF</span> <span class="token variable">@partitioncount</span> <span class="token operator">&gt;</span> <span class="token number">1</span>  
            <span class="token keyword">SET</span> <span class="token variable">@command</span> <span class="token operator">=</span> <span class="token variable">@command</span> <span class="token operator">+</span> N<span class="token string">&#39; PARTITION=&#39;</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@partitionnum</span> <span class="token keyword">AS</span> nvarchar<span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">EXEC</span> <span class="token punctuation">(</span><span class="token variable">@command</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
        <span class="token keyword">PRINT</span> CAST<span class="token punctuation">(</span><span class="token variable">@tagid</span> <span class="token keyword">as</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> CAST<span class="token punctuation">(</span><span class="token variable">@indexcount</span> <span class="token keyword">as</span> NVARCHAR<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> N<span class="token string">&#39; Executed: &#39;</span> <span class="token operator">+</span> <span class="token variable">@command</span><span class="token punctuation">;</span>
    <span class="token keyword">END</span><span class="token punctuation">;</span>  
  
<span class="token comment">-- Close and deallocate the cursor.  </span>
<span class="token keyword">CLOSE</span> partitions<span class="token punctuation">;</span>  
<span class="token keyword">DEALLOCATE</span> partitions<span class="token punctuation">;</span>  
  
<span class="token comment">-- Drop the temporary table.  </span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token comment">#work_to_do;  </span>
GO
</code></pre><div class="highlight-lines"><br><br><br><br><br><br><br><br><div class="highlight-line"> </div><div class="highlight-line"> </div><div class="highlight-line"> </div><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br></div><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-3-查找缺失索引组的缺失索引及其列详细信息" tabindex="-1"><a class="header-anchor" href="#_1-3-查找缺失索引组的缺失索引及其列详细信息"><span>1.3. 查找缺失索引组的缺失索引及其列详细信息</span></a></h3><div class="custom-container warning"><p class="custom-container-title">注意</p><p><code>sys.dm_db_missing_index_group_stats</code>记录的使用情况统计信息。</p><ul><li>由每次查询执行更新，而不是每次查询编译或重新编译更新。</li><li>使用情况统计信息不会持久保存，重新启动数据库引擎后会重置。 如果要保留使用情况统计信息，则应该定期制作缺失索引信息的备份副本。</li></ul><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/index-related-dynamic-management-views-and-functions-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">与索引相关的动态管理视图和函数<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p>相关章节：<a href="#_5-1-%E6%9F%A5%E8%AF%A2sql-server%E5%90%AF%E5%8A%A8%E6%97%B6%E9%97%B4">查询上次数据库引擎启动时间</a></p></div><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/* 查找缺失索引组的缺失索引及其列详细信息
   此 DMV 的结果集限制为600行。 每一行都包含一个缺失索引。 如果缺少超过600个索引
*/</span>
<span class="token keyword">SELECT</span>
  <span class="token comment">-- DMV 信息</span>
  gStats<span class="token punctuation">.</span>avg_total_user_cost <span class="token operator">*</span> <span class="token punctuation">(</span>gStats<span class="token punctuation">.</span>avg_user_impact <span class="token operator">/</span> <span class="token number">100.0</span><span class="token punctuation">)</span> <span class="token operator">*</span><span class="token punctuation">(</span>gStats<span class="token punctuation">.</span>user_seeks <span class="token operator">+</span> gStats<span class="token punctuation">.</span>user_scans<span class="token punctuation">)</span> <span class="token keyword">AS</span> 实现索引的收益指数<span class="token punctuation">,</span>
  gStats<span class="token punctuation">.</span>avg_total_user_cost <span class="token keyword">AS</span> 缺失索引的查询成本<span class="token punctuation">,</span> <span class="token comment">-- 可通过组中的索引减少的用户查询的平均成本</span>
  gStats<span class="token punctuation">.</span>avg_user_impact <span class="token keyword">AS</span> <span class="token punctuation">[</span>实现索引 用户的收益（<span class="token operator">%</span>）<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">-- 实现此缺失索引组后，用户查询可能获得的平均百分比收益</span>
  gStats<span class="token punctuation">.</span>avg_system_impact <span class="token keyword">AS</span> <span class="token punctuation">[</span>实现索引 系统的收益（<span class="token operator">%</span>）<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">-- 实现此缺失索引组后，系统查询可能获得的平均百分比收益。</span>
  gStats<span class="token punctuation">.</span>user_seeks <span class="token keyword">AS</span> 查找次数<span class="token punctuation">,</span> <span class="token comment">-- 由可能使用了组中建议索引的用户查询所导致的查找次数</span>
  gStats<span class="token punctuation">.</span>user_scans <span class="token keyword">AS</span> 扫描次数<span class="token punctuation">,</span> <span class="token comment">-- 由可能使用了组中建议索引的用户查询所导致的扫描次数</span>

  i<span class="token punctuation">.</span>database_id <span class="token keyword">AS</span> 数据库ID<span class="token punctuation">,</span> 
  DB_NAME<span class="token punctuation">(</span> i<span class="token punctuation">.</span>database_id <span class="token punctuation">)</span> <span class="token keyword">AS</span> 数据库<span class="token punctuation">,</span>
  i<span class="token punctuation">.</span><span class="token punctuation">[</span>object_id<span class="token punctuation">]</span> <span class="token keyword">AS</span> 缺失索引的表ID<span class="token punctuation">,</span>
  OBJECT_NAME<span class="token punctuation">(</span> i<span class="token punctuation">.</span><span class="token punctuation">[</span>object_id<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>database_id <span class="token punctuation">)</span> <span class="token keyword">AS</span> 缺失索引的表<span class="token punctuation">,</span>

  <span class="token comment">-- 创建索引的SQL语句</span>
  <span class="token string">&#39;CREATE INDEX [IX_&#39;</span> <span class="token operator">+</span> OBJECT_NAME<span class="token punctuation">(</span> i<span class="token punctuation">.</span><span class="token punctuation">[</span>object_id<span class="token punctuation">]</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>database_id <span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;_&#39;</span> <span class="token operator">+</span> <span class="token keyword">CONVERT</span> <span class="token punctuation">(</span><span class="token keyword">varchar</span><span class="token punctuation">,</span> g<span class="token punctuation">.</span>index_group_handle<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;_&#39;</span> <span class="token operator">+</span> <span class="token keyword">CONVERT</span> <span class="token punctuation">(</span><span class="token keyword">varchar</span><span class="token punctuation">,</span> i<span class="token punctuation">.</span>index_handle<span class="token punctuation">)</span> 
  <span class="token operator">+</span>  <span class="token string">&#39;]&#39;</span>
  <span class="token operator">+</span> <span class="token string">&#39; ON &#39;</span> <span class="token operator">+</span> i<span class="token punctuation">.</span>statement
  <span class="token operator">+</span> <span class="token string">&#39; (&#39;</span> <span class="token operator">+</span> ISNULL <span class="token punctuation">(</span>i<span class="token punctuation">.</span>equality_columns<span class="token punctuation">,</span><span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
  <span class="token operator">+</span> <span class="token keyword">CASE</span> <span class="token keyword">WHEN</span> i<span class="token punctuation">.</span>equality_columns <span class="token operator">IS</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token operator">AND</span> i<span class="token punctuation">.</span>inequality_columns <span class="token operator">IS</span> <span class="token operator">NOT</span> 
<span class="token boolean">NULL</span> <span class="token keyword">THEN</span> <span class="token string">&#39;,&#39;</span> <span class="token keyword">ELSE</span> <span class="token string">&#39;&#39;</span> <span class="token keyword">END</span>
  <span class="token operator">+</span> ISNULL <span class="token punctuation">(</span>i<span class="token punctuation">.</span>inequality_columns<span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span>
  <span class="token operator">+</span> <span class="token string">&#39;)&#39;</span>
  <span class="token operator">+</span> ISNULL <span class="token punctuation">(</span><span class="token string">&#39; INCLUDE (&#39;</span> <span class="token operator">+</span> i<span class="token punctuation">.</span>included_columns <span class="token operator">+</span> <span class="token string">&#39;)&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;&#39;</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>创建索引的<span class="token keyword">SQL</span>语句<span class="token punctuation">]</span>

<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_missing_index_groups g <span class="token comment">-- 缺失索引组（一个索引组仅包含一个索引）</span>
       <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>dm_db_missing_index_group_stats gStats <span class="token keyword">ON</span> <span class="token comment">-- 缺失索引组的摘要信息</span>
               gStats<span class="token punctuation">.</span>group_handle <span class="token operator">=</span> g<span class="token punctuation">.</span>index_group_handle
       <span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>dm_db_missing_index_details i <span class="token keyword">ON</span>  <span class="token comment">-- 缺失索引的详细信息</span>
              g<span class="token punctuation">.</span>index_handle <span class="token operator">=</span> i<span class="token punctuation">.</span>index_handle
<span class="token comment">-- where i.database_id = DB_ID( &#39;指定数据库&#39; )</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> gStats<span class="token punctuation">.</span>avg_total_user_cost <span class="token operator">*</span> gStats<span class="token punctuation">.</span>avg_user_impact <span class="token operator">*</span> <span class="token punctuation">(</span>gStats<span class="token punctuation">.</span>user_seeks <span class="token operator">+</span> gStats<span class="token punctuation">.</span>user_scans<span class="token punctuation">)</span> <span class="token keyword">DESC</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_1-4-指定索引的填充因子" tabindex="-1"><a class="header-anchor" href="#_1-4-指定索引的填充因子"><span>1.4 指定索引的填充因子</span></a></h3><p>当创建/重新生成索引时，<code>填充因子</code>的值可确定每个叶级页上要填充数据的空间百分比。</p><p><code>填充因子</code>的值是 1 到 100 之间的百分比（0 和 100 是相同的），服务器范围的默认值为 0。</p><p>例如：</p><ul><li><p>指定<code>填充因子</code>的值为 80 表示每个叶级页上保留 20% 可用空间（可用空间在索引行之间保留，而不是在索引的末尾保留），以便随着向基础表中添加数据而为扩展索引提供空间。</p></li><li><p>指定<code>填充因子</code>的值为 0或100，则表示将完全填充叶级页。</p></li></ul><p><code>填充因子</code>的值建议：</p><ul><li>如果新数据在表中均匀分布，则设置 0 到 100 之间对性能有利。</li><li>如果新数据都添加到表的末尾，则设置0或100对性能有利。</li></ul><div class="custom-container warning"><p class="custom-container-title">注意</p><p>在许多工作负载中，提高页面密度会比减少碎片更能提升性能。</p><p>为避免在不必要的情况下降低页面密度，Microsoft 不建议将填充因子设置为 100 或 0 以外的值，除非索引遇到大量<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/indexes/specify-fill-factor-for-an-index?view=sql-server-ver15#page-splits" target="_blank" rel="noopener noreferrer">页面拆分<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>，例如，包含非顺序 GUID 值的前导列并且频繁修改的索引。</p></div><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span><span class="token punctuation">;</span>  
GO  

<span class="token comment">-- 重新生成索引</span>
<span class="token keyword">ALTER</span> <span class="token keyword">INDEX</span> IX_Employee <span class="token keyword">ON</span> HumanResources<span class="token punctuation">.</span>Employee  
REBUILD <span class="token keyword">WITH</span> <span class="token punctuation">(</span><span class="token keyword">FILLFACTOR</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
GO
<span class="token comment">-- 创建索引</span>
<span class="token keyword">CREATE</span> <span class="token keyword">INDEX</span> IX_Employee <span class="token keyword">ON</span> HumanResources<span class="token punctuation">.</span>Employee<span class="token punctuation">(</span>OrganizationLevel<span class="token punctuation">,</span> OrganizationNode<span class="token punctuation">)</span>   
<span class="token keyword">WITH</span> <span class="token punctuation">(</span>DROP_EXISTING <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">,</span> <span class="token keyword">FILLFACTOR</span> <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/indexes/specify-fill-factor-for-an-index?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">为索引指定填充因子 MSDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_1-5-查询表的所有索引和索引列" tabindex="-1"><a class="header-anchor" href="#_1-5-查询表的所有索引和索引列"><span>1.5 查询表的所有索引和索引列</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span><span class="token punctuation">;</span>  
GO  
<span class="token keyword">SELECT</span> i<span class="token punctuation">.</span>name <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引<span class="token punctuation">]</span>  
    <span class="token punctuation">,</span>COL_NAME<span class="token punctuation">(</span>ic<span class="token punctuation">.</span>object_id<span class="token punctuation">,</span>ic<span class="token punctuation">.</span>column_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引列<span class="token punctuation">]</span>  
    <span class="token punctuation">,</span>ic<span class="token punctuation">.</span>index_column_id  
    <span class="token punctuation">,</span>ic<span class="token punctuation">.</span>key_ordinal <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引列的序号<span class="token punctuation">]</span>
    <span class="token punctuation">,</span>ic<span class="token punctuation">.</span>is_included_column <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引列是否属包含列<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>indexes <span class="token keyword">AS</span> i  
<span class="token keyword">INNER</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>index_columns <span class="token keyword">AS</span> ic
    <span class="token keyword">ON</span> i<span class="token punctuation">.</span>object_id <span class="token operator">=</span> ic<span class="token punctuation">.</span>object_id <span class="token operator">AND</span> i<span class="token punctuation">.</span>index_id <span class="token operator">=</span> ic<span class="token punctuation">.</span>index_id  
<span class="token keyword">WHERE</span> i<span class="token punctuation">.</span>object_id <span class="token operator">=</span> OBJECT_ID<span class="token punctuation">(</span><span class="token string">&#39;SMInvoiceDetail&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">--  表名</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-catalog-views/sys-index-columns-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sys.index_columns<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h3 id="_1-6-查询索引使用统计" tabindex="-1"><a class="header-anchor" href="#_1-6-查询索引使用统计"><span>1.6 查询索引使用统计</span></a></h3><p>返回索引操作的计数以及上次执行每种操作的时间。</p><p>统计结果中的 <code>user_updates</code> (用户更新次数) 列是基础表或视图上插入、更新或删除操作导致的索引的维护计数器。 可以使用此视图确定应用程序极少使用的索引。 还可以使用此视图确定引发维护开销的索引。 您可能要删除引发维护开销但不用于查询或只是偶尔用于查询的索引。</p><div class="custom-container warning"><p class="custom-container-title">注意</p><p>每当进行 SQL Server 服务重启和数据库分离\关闭时，统计信息都将会被清空重置。</p></div><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> <span class="token punctuation">[</span>输入数据库名<span class="token punctuation">]</span>
GO
<span class="token keyword">SELECT</span>
  DB_Name<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>database_id<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> o<span class="token punctuation">.</span>name <span class="token keyword">AS</span> <span class="token punctuation">[</span>表名<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> p<span class="token punctuation">.</span>TableRows <span class="token keyword">AS</span> 表行数
  <span class="token punctuation">,</span> i<span class="token punctuation">.</span>name <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引名<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> i<span class="token punctuation">.</span>type_desc <span class="token keyword">AS</span> <span class="token punctuation">[</span>索引类型<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> QUOTENAME<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>user_seeks<span class="token punctuation">)</span> 
    <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>user_scans<span class="token punctuation">)</span> 
    <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>user_lookups<span class="token punctuation">)</span> 
    <span class="token operator">+</span> <span class="token string">&#39;/&#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>user_updates<span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>用户【搜索<span class="token operator">/</span>扫描<span class="token operator">/</span>查找<span class="token operator">/</span>更新】次数<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> dm_ius<span class="token punctuation">.</span>last_user_seek <span class="token keyword">AS</span> <span class="token punctuation">[</span>用户上次执行搜索的时间<span class="token punctuation">]</span>
  <span class="token punctuation">,</span> <span class="token string">&#39;DROP INDEX &#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>i<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39; ON &#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>s<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&#39;.&#39;</span> <span class="token operator">+</span> QUOTENAME<span class="token punctuation">(</span>OBJECT_NAME<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token string">&#39;删除索引语句&#39;</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_db_index_usage_stats dm_ius
	<span class="token keyword">Left</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>indexes i 
	  <span class="token keyword">ON</span> i<span class="token punctuation">.</span>index_id <span class="token operator">=</span> dm_ius<span class="token punctuation">.</span>index_id <span class="token operator">AND</span> dm_ius<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">=</span> i<span class="token punctuation">.</span>OBJECT_ID
	<span class="token keyword">Left</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>objects o 
	  <span class="token keyword">ON</span> dm_ius<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">=</span> o<span class="token punctuation">.</span>OBJECT_ID
	<span class="token keyword">Left</span> <span class="token keyword">JOIN</span> sys<span class="token punctuation">.</span>schemas s 
	  <span class="token keyword">ON</span> o<span class="token punctuation">.</span>schema_id <span class="token operator">=</span> s<span class="token punctuation">.</span>schema_id
	<span class="token keyword">Left</span> <span class="token keyword">JOIN</span> <span class="token punctuation">(</span><span class="token keyword">SELECT</span> <span class="token function">SUM</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token keyword">rows</span><span class="token punctuation">)</span> TableRows<span class="token punctuation">,</span> p<span class="token punctuation">.</span>index_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>OBJECT_ID <span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>partitions p <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> p<span class="token punctuation">.</span>index_id<span class="token punctuation">,</span> p<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">)</span> p 
	  <span class="token keyword">ON</span> p<span class="token punctuation">.</span>index_id <span class="token operator">=</span> dm_ius<span class="token punctuation">.</span>index_id <span class="token operator">AND</span> dm_ius<span class="token punctuation">.</span>OBJECT_ID <span class="token operator">=</span> p<span class="token punctuation">.</span>OBJECT_ID
<span class="token keyword">WHERE</span> 
<span class="token comment">-- 用户定义的表</span>
OBJECTPROPERTY<span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>OBJECT_ID<span class="token punctuation">,</span><span class="token string">&#39;IsUserTable&#39;</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">1</span>
<span class="token comment">-- 非聚集索引</span>
<span class="token operator">AND</span> i<span class="token punctuation">.</span>type_desc <span class="token operator">=</span> <span class="token string">&#39;NONCLUSTERED&#39;</span>
<span class="token operator">AND</span> i<span class="token punctuation">.</span>is_primary_key <span class="token operator">=</span> <span class="token number">0</span>
<span class="token operator">AND</span> i<span class="token punctuation">.</span>is_unique_constraint <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment">/** 指定数据库条件 */</span>
<span class="token comment">--AND dm_ius.database_id = DB_ID(&#39;输入数据库名&#39;)</span>
<span class="token comment">/** 指定表名条件 */</span>
<span class="token comment">--AND o.name=&#39;表名&#39;  </span>

<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">(</span>dm_ius<span class="token punctuation">.</span>user_seeks <span class="token operator">+</span> dm_ius<span class="token punctuation">.</span>user_scans <span class="token operator">+</span> dm_ius<span class="token punctuation">.</span>user_lookups<span class="token punctuation">)</span> <span class="token keyword">ASC</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行结果</strong><img src="/document/images/sqlserver-performance-analysis/1.6.jpg" alt="执行结果"></p><blockquote><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/previous-versions/sql/sql-server-2012/ms188755(v=sql.110)" target="_blank" rel="noopener noreferrer">sys.dm_db_index_usage_stats (Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><h2 id="_2-数据库文件和文件组" tabindex="-1"><a class="header-anchor" href="#_2-数据库文件和文件组"><span>2 数据库文件和文件组</span></a></h2><h3 id="_2-1-数据库文件" tabindex="-1"><a class="header-anchor" href="#_2-1-数据库文件"><span>2.1 数据库文件</span></a></h3><p>SQL Server 数据库具有三种类型的文件，如下表所示：</p><table><thead><tr><th style="text-align:left;">文件</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">主</td><td style="text-align:left;">包含数据库的启动信息，并指向数据库中的其他文件。 每个数据库有一个主要数据文件。 主要数据文件的建议文件扩展名是 .mdf。</td></tr><tr><td style="text-align:left;">辅助副本</td><td style="text-align:left;">用户定义的可选数据文件。 通过将每个文件放在不同的磁盘驱动器上，可将数据分散到多个磁盘中。 次要数据文件的建议文件扩展名是 .ndf。</td></tr><tr><td style="text-align:left;">事务日志</td><td style="text-align:left;">此日志包含用于恢复数据库的信息。 每个数据库必须至少有一个日志文件。 事务日志的建议文件扩展名是 .ldf。</td></tr></tbody></table><h3 id="_2-2-文件组" tabindex="-1"><a class="header-anchor" href="#_2-2-文件组"><span>2.2 文件组</span></a></h3><ul><li>此文件组包含主要数据文件和未放入其他文件组的所有次要文件。</li><li>可以创建用户定义的文件组，用于将数据文件集合起来，以便于管理、数据分配和放置。</li></ul><p>例如：可以分别在<code>三个磁盘驱动器</code>上创建 <code>Data1.ndf</code>、<code>Data2.ndf</code> 和 <code>Data3.ndf</code>，然后将它们分配给文件组 <code>fgroup1</code>。 然后，可以明确地在文件组 <code>fgroup1</code> 上创建一个表。 对表中数据的查询将分散到三个磁盘上，从而提高了性能。 通过使用在 RAID（独立磁盘冗余阵列）条带集上创建的单个文件也能获得同样的性能提高。</p><p>下表列出了存储在文件组中的所有数据文件。</p><table><thead><tr><th style="text-align:left;">文件组</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">主</td><td style="text-align:left;">包含主要文件的文件组。 所有系统表都是主要文件组的一部分。</td></tr><tr><td style="text-align:left;">内存优化数据</td><td style="text-align:left;">内存优化文件组基于 Filestream 文件组</td></tr><tr><td style="text-align:left;">文件流</td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;">用户定义</td><td style="text-align:left;">用户首次创建数据库或以后修改数据库时创建的任何文件组。</td></tr></tbody></table><p><strong><code>建议</code></strong></p><ul><li><p>将数据和日志文件放在不同的磁盘上。</p></li><li><p>若要使性能最大化，请在尽可能多的不同可用磁盘上创建文件或文件组。 将争夺空间最激烈的对象置于不同的文件组中。</p></li><li><p>大多数数据库在只有单个数据文件和单个事务日志文件的情况下性能良好。</p></li><li><p>如果使用多个数据文件，请为附加文件创建第二个文件组，并将其设置为默认文件组。 这样，主文件将只包含系统表和对象。</p></li><li><p>使用文件组将对象放置在特定的物理磁盘上。</p></li><li><p>将在同一联接查询中使用的不同表置于不同的文件组中。 由于采用并行磁盘 I/O 对联接数据进行搜索，所以此步骤可改善性能。</p></li></ul><blockquote><p><strong>引用</strong></p><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/databases/database-files-and-filegroups?view=sql-server-2016" target="_blank" rel="noopener noreferrer">数据库文件和文件组 MSDN<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><h3 id="_2-3-添加文件和文件组" tabindex="-1"><a class="header-anchor" href="#_2-3-添加文件和文件组"><span>2.3 添加文件和文件组</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- ”AdventureWorks2012”为示例数据库，请修改为需要操作的目标数据库。</span>
<span class="token keyword">USE</span> master
GO

<span class="token comment">-- 创建文件组 Test1FG1</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2012
<span class="token keyword">ADD</span> FILEGROUP Test1FG1<span class="token punctuation">;</span>
GO

<span class="token comment">-- 添加文件 test1dat1 到 文件组 Test1FG1</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2012
<span class="token keyword">ADD</span> <span class="token keyword">FILE</span>
<span class="token punctuation">(</span>
    NAME <span class="token operator">=</span> test1dat1<span class="token punctuation">,</span>
    FILENAME <span class="token operator">=</span> <span class="token string">&#39;C:\Program Files\Microsoft SQL Server\MSSQL13.MSSQLSERVER\MSSQL\DATA\t1dat1.ndf&#39;</span><span class="token punctuation">,</span>
    SIZE <span class="token operator">=</span> <span class="token number">5</span>MB<span class="token punctuation">,</span>
    MAXSIZE <span class="token operator">=</span> UNLIMITED<span class="token punctuation">,</span>
    FILEGROWTH <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">%</span>
<span class="token punctuation">)</span>
<span class="token keyword">TO</span> FILEGROUP Test1FG1<span class="token punctuation">;</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-移动文件" tabindex="-1"><a class="header-anchor" href="#_2-4-移动文件"><span>2.4 移动文件</span></a></h3><ul><li><p><strong>移动用户数据库</strong></p><ol><li><p>查询数据库的逻辑文件名称</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> name <span class="token keyword">as</span> <span class="token punctuation">[</span>逻辑名称<span class="token punctuation">]</span><span class="token punctuation">,</span> physical_name <span class="token keyword">AS</span> CurrentLocation<span class="token punctuation">,</span> state_desc  
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>master_files  
<span class="token keyword">WHERE</span> database_id <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span>N<span class="token string">&#39;数据库名&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>更改文件位置</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> 数据库名 
<span class="token keyword">MODIFY</span> <span class="token keyword">FILE</span> <span class="token punctuation">(</span> NAME <span class="token operator">=</span> 逻辑名称<span class="token punctuation">,</span> FILENAME <span class="token operator">=</span> <span class="token string">&#39;新路径 C:\Gitee\document\xxx.ldf&#39;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>设置数据库脱机\停止SQL Server服务</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> database_name <span class="token keyword">SET</span> OFFLINE<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li><li><p>将文件移动到新位置</p></li><li><p>设置数据库联机\启动SQL Server服务</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> database_name <span class="token keyword">SET</span> ONLINE<span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div></li></ol></li><li><p><strong>移动TempDB数据库</strong></p></li></ul><div class="custom-container warning"><p class="custom-container-title">注意</p><p>由于每次启动 SQL Server 实例时都将重新创建 tempdb，所以不必实际移动数据和日志文件。</p></div><ol><li><p>查询<code>tempdb</code> 数据库的逻辑文件名称</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">SELECT</span> name <span class="token keyword">as</span> <span class="token punctuation">[</span>逻辑名称<span class="token punctuation">]</span><span class="token punctuation">,</span> physical_name <span class="token keyword">AS</span> CurrentLocation  
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>master_files  
<span class="token keyword">WHERE</span> database_id <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span>N<span class="token string">&#39;tempdb&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>更改每个文件的位置</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">USE</span> master<span class="token punctuation">;</span>  
GO  
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> tempdb   
<span class="token keyword">MODIFY</span> <span class="token keyword">FILE</span> <span class="token punctuation">(</span>NAME <span class="token operator">=</span> 逻辑名称<span class="token punctuation">,</span> FILENAME <span class="token operator">=</span> <span class="token string">&#39;新路径 E:\SQLData\tempdb.mdf&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
GO  
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> tempdb   
<span class="token keyword">MODIFY</span> <span class="token keyword">FILE</span> <span class="token punctuation">(</span>NAME <span class="token operator">=</span> 逻辑名称<span class="token punctuation">,</span> FILENAME <span class="token operator">=</span> <span class="token string">&#39;新路径 F:\SQLLog\templog.ldf&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
GO  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>停止再重新启动 SQL Server的实例。</p></li><li><p>将 <code>tempdb.mdf</code> 和 <code>templog.ldf</code> 文件从其原始位置删除。</p></li></ol><blockquote><p><strong>引用 MSDN</strong></p><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/databases/move-user-databases?view=sql-server-2016" target="_blank" rel="noopener noreferrer">移动用户数据库<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/databases/move-system-databases?view=sql-server-2016#examples" target="_blank" rel="noopener noreferrer">移动系统数据库<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><hr><h2 id="_3-日志文件" tabindex="-1"><a class="header-anchor" href="#_3-日志文件"><span>3 日志文件</span></a></h2><h3 id="_3-1-收缩日志" tabindex="-1"><a class="header-anchor" href="#_3-1-收缩日志"><span>3.1 收缩日志</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 以下示例将 AdventureWorks2022 数据库中的日志文件收缩到 1 MB。</span>
<span class="token keyword">USE</span> AdventureWorks2022<span class="token punctuation">;</span>
GO
<span class="token comment">-- 首先需要通过将数据库恢复模式设置为 SIMPLE 来截断该文件</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2022
<span class="token keyword">SET</span> RECOVERY <span class="token keyword">SIMPLE</span><span class="token punctuation">;</span>
GO
<span class="token comment">-- 日志文收缩到 1 MB</span>
<span class="token comment">-- AdventureWorks2022_Log 为日志文件的“逻辑名称</span>
<span class="token keyword">DBCC</span> SHRINKFILE <span class="token punctuation">(</span>AdventureWorks2022_Log<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
GO
<span class="token comment">-- Reset the database recovery model.</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2022
<span class="token keyword">SET</span> RECOVERY <span class="token keyword">FULL</span><span class="token punctuation">;</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关详细信息，请参阅<a href="https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-shrinkfile-transact-sql?view=sql-server-ver16#examples" target="_blank" rel="noopener noreferrer">DBCC SHRINKFILE (Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h3 id="_3-2-日志无法收缩的部分解决办法" tabindex="-1"><a class="header-anchor" href="#_3-2-日志无法收缩的部分解决办法"><span>3.2 日志无法收缩的部分解决办法</span></a></h3><blockquote><p><a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/logs/the-transaction-log-sql-server?view=sql-server-ver15#factors-that-can-delay-log-truncation" target="_blank" rel="noopener noreferrer">MSDN文档： 可能延迟日志截断的因素<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><ol><li>查询日志无法收缩的原因</li></ol><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/**********************************/</span> 
<span class="token comment">/* 查看影响日志无法收缩的原因       */</span>
<span class="token comment">/*********************************/</span>
<span class="token keyword">select</span> log_reuse_wait_desc 
<span class="token keyword">from</span> sys<span class="token punctuation">.</span><span class="token keyword">databases</span> 
<span class="token keyword">where</span> name <span class="token operator">=</span> <span class="token string">&#39;数据库名称&#39;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li>查询结果说明</li></ol><ul><li><strong>NOTHING</strong><strong>说明：</strong></li></ul><p>当前有一个或多个可重复使用的虚拟日志文件 (VLF)。</p><p><strong>解决</strong>：</p><p>显示<code>NOTHING</code>时，一般情况都是可以收缩。</p><ul><li><p><strong>LOG_BACKUP</strong><strong>说明</strong>： 在截断事务日志前，需要进行日志备份。 （仅限完整恢复模式或大容量日志恢复模式） <strong>解决</strong>： 通常情况备份事务日志后*(如果无法备份事务日志，就需要先进行完整备份，再备份事务日志)*，再次查询结果为<code>NOTHING</code>，就可以收缩到日志文件了。</p></li><li><p><strong>REPLICATION</strong><strong>说明</strong>：在事务复制过程中，与发布相关的事务仍未传递到分发数据库。 （仅限完整恢复模式） <strong>解决</strong>： 1.将日志中的所有复制的事务都被标记为已分发，再次查询结果为<code>NOTHING</code>，就可以收缩到日志文件。</p></li></ul><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/**********************************/</span> 
<span class="token comment">/* 将日志中的所有复制的事务都被标记为已分发 */</span>
<span class="token comment">/*********************************/</span>
<span class="token keyword">EXEC</span> sp_repldone <span class="token variable">@xactid</span> <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token variable">@xact_seqno</span> <span class="token operator">=</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token variable">@numtrans</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">@time</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token variable">@reset</span> <span class="token operator">=</span> <span class="token number">1</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>​ 2.禁用发布，再次查询结果为<code>NOTHING</code>，就可以收缩到日志文件。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/****************/</span> 
<span class="token comment">/* 禁用发布和分发 */</span>
<span class="token comment">/****************/</span>
<span class="token keyword">EXEC</span> sp_removedbreplication <span class="token punctuation">[</span>数据库名称<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container warning"><p class="custom-container-title">注意</p><p>如果手动执行 sp_repldone，则可以使已传送的事务的次序和一致性无效。</p><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sp-repldone-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sp_repldone (Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> <a href="https://docs.microsoft.com/zh-cn/sql/relational-databases/system-stored-procedures/sp-removedbreplication-transact-sql?view=sql-server-ver15" target="_blank" rel="noopener noreferrer">sp_removedbreplication(Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><hr><h2 id="_4-执行计划" tabindex="-1"><a class="header-anchor" href="#_4-执行计划"><span>4 执行计划</span></a></h2><h3 id="_4-1-清除计划缓存" tabindex="-1"><a class="header-anchor" href="#_4-1-清除计划缓存"><span>4.1 清除计划缓存</span></a></h3><div class="custom-container warning"><p class="custom-container-title">注意</p><ul><li>DBCC FREEPROCCACHE 不清除本机编译的存储过程的执行统计信息。</li><li>清除过程（计划）缓存会逐出所有计划，并且传入查询执行将编译新计划，而不是重复使用任何以前缓存的计划，这可能导致查询性能骤降。</li></ul><p>有关详细信息，请参阅<a href="https://docs.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-freeproccache-transact-sql?view=sql-server-ver15#examples-ssnoversion" target="_blank" rel="noopener noreferrer">DBCC FREEPROCCACHE(Transact-SQL)<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></div><ol><li><p>清除所有计划缓存</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- **** 清除所有计划缓存 ****</span>
<span class="token keyword">DBCC</span> FREEPROCCACHE
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>清除指定计划缓存</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- **** 清除指定计划 ****</span>
<span class="token keyword">USE</span> <span class="token punctuation">[</span>数据库名<span class="token punctuation">]</span><span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 1.查询语句</span>
<span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> Person<span class="token punctuation">.</span>Address<span class="token punctuation">;</span>  
GO  
<span class="token comment">-- 2.查询语句的执行计划</span>
<span class="token keyword">SELECT</span> plan_handle<span class="token punctuation">,</span> st<span class="token punctuation">.</span><span class="token keyword">text</span>  
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_cached_plans   
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>plan_handle<span class="token punctuation">)</span> <span class="token keyword">AS</span> st  
<span class="token keyword">WHERE</span> <span class="token keyword">text</span> <span class="token operator">LIKE</span> N<span class="token string">&#39;SELECT * FROM Person.Address%&#39;</span><span class="token punctuation">;</span>  
GO  
<span class="token comment">/* 执行结果
plan_handle                                         text  
--------------------------------------------------  -----------------------------  
0x060006001ECA270EC0215D05000000000000000000000000  SELECT * FROM Person.Address;  
*/</span>
<span class="token comment">-- 3.清除指定执行计划缓存</span>
<span class="token keyword">DBCC</span> FREEPROCCACHE <span class="token punctuation">(</span><span class="token number">0x060006001ECA270EC0215D05000000000000000000000000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h2 id="_5-系统信息" tabindex="-1"><a class="header-anchor" href="#_5-系统信息"><span>5 系统信息</span></a></h2><h3 id="_5-1-查询sql-server启动时间" tabindex="-1"><a class="header-anchor" href="#_5-1-查询sql-server启动时间"><span>5.1 查询SQL Server启动时间</span></a></h3><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- **** 查询SQL Server启动时间 ****</span>
<span class="token keyword">select</span>  
sqlserver_start_time <span class="token keyword">as</span> <span class="token punctuation">[</span>启动日期<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">(</span>ms_ticks<span class="token operator">-</span>sqlserver_start_time_ms_ticks<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">60</span><span class="token operator">/</span><span class="token number">60.0</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>持续运行时间（小时）<span class="token punctuation">]</span>
<span class="token keyword">from</span> sys<span class="token punctuation">.</span>dm_os_sys_info
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行结果</strong></p><p><img src="/document/images/sqlserver-performance-analysis/5.1.jpg" alt=""></p></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="external-link meta-item-label" href="https://github.com/fschenzihao/document/edit/master/docs/sql-server/sqlserver-performance-analysis.md" rel="noopener noreferrer" target="_blank" aria-label="编辑此页"><!--[--><!--]--> 编辑此页 <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">上次编辑于: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/document/assets/app-CUvyzFzm.js" defer></script>
  </body>
</html>
