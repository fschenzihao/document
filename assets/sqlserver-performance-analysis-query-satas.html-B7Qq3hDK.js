import{_ as e,r as o,o as c,c as l,a as n,d as s,b as t,e as p}from"./app-CUvyzFzm.js";const u={},i=p(`<h1 id="执行计划的统计信息" tabindex="-1"><a class="header-anchor" href="#执行计划的统计信息"><span>执行计划的统计信息</span></a></h1><p>返回 SQL Server 中缓存的查询计划的聚合性能统计信息。</p><p>与“活动监视器”中的“最近耗费大量资源的查询”页签中的数据同源。</p><div class="custom-container warning"><p class="custom-container-title">注意</p><p>重启SQL Server服务或删除执行计划缓存都会影响当前查询结果</p></div><h2 id="sql语句" tabindex="-1"><a class="header-anchor" href="#sql语句"><span>SQL语句</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/*
 * 查询平均每次执行用时大于100ms的SQL语句
*/</span>
<span class="token keyword">SELECT</span>
ISNULL<span class="token punctuation">(</span>ST<span class="token punctuation">.</span>dbid<span class="token punctuation">,</span> SP<span class="token punctuation">.</span>dbid<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库ID<span class="token punctuation">]</span><span class="token punctuation">,</span>
DB_NAME<span class="token punctuation">(</span>isnull<span class="token punctuation">(</span>ST<span class="token punctuation">.</span>dbid<span class="token punctuation">,</span> SP<span class="token punctuation">.</span>dbid<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库名称<span class="token punctuation">]</span><span class="token punctuation">,</span>
QS<span class="token punctuation">.</span>query_hash <span class="token keyword">as</span> <span class="token punctuation">[</span>查询哈希<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">-- 可以使用查询哈希确定仅仅是文字值不同的查询的聚合资源使用情况</span>
QS<span class="token punctuation">.</span>total_worker_time <span class="token operator">/</span> <span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>CPU使用时间<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
QS<span class="token punctuation">.</span>total_elapsed_time <span class="token operator">/</span> <span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
QS<span class="token punctuation">.</span>execution_count <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总次数<span class="token punctuation">]</span><span class="token punctuation">,</span>
QS<span class="token punctuation">.</span>total_elapsed_time <span class="token operator">/</span> QS<span class="token punctuation">.</span>execution_count <span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>平均每次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
ST<span class="token punctuation">.</span>encrypted <span class="token keyword">as</span> <span class="token punctuation">[</span>语句已加密<span class="token punctuation">]</span><span class="token punctuation">,</span>
SUBSTRING<span class="token punctuation">(</span>ST<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>QS<span class="token punctuation">.</span>statement_start_offset<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">,</span>  
  <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">CASE</span> statement_end_offset   
   <span class="token keyword">WHEN</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token keyword">THEN</span> DATALENGTH<span class="token punctuation">(</span>ST<span class="token punctuation">.</span><span class="token keyword">text</span><span class="token punctuation">)</span>  
   <span class="token keyword">ELSE</span> QS<span class="token punctuation">.</span>statement_end_offset <span class="token keyword">END</span>   
   <span class="token operator">-</span> QS<span class="token punctuation">.</span>statement_start_offset<span class="token punctuation">)</span><span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>查询语句<span class="token punctuation">]</span><span class="token punctuation">,</span>
SP<span class="token punctuation">.</span>query_plan <span class="token keyword">as</span> <span class="token punctuation">[</span>执行计划<span class="token punctuation">]</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_query_stats <span class="token keyword">AS</span> QS  
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_sql_text<span class="token punctuation">(</span>QS<span class="token punctuation">.</span>sql_handle<span class="token punctuation">)</span> <span class="token keyword">as</span> ST
<span class="token keyword">CROSS</span> <span class="token keyword">APPLY</span> sys<span class="token punctuation">.</span>dm_exec_query_plan<span class="token punctuation">(</span>QS<span class="token punctuation">.</span>plan_handle<span class="token punctuation">)</span> <span class="token keyword">as</span> SP
<span class="token keyword">WHERE</span> ISNULL<span class="token punctuation">(</span>ST<span class="token punctuation">.</span>dbid<span class="token punctuation">,</span> SP<span class="token punctuation">.</span>dbid<span class="token punctuation">)</span> <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">&#39;数据库名&#39;</span><span class="token punctuation">)</span>
<span class="token operator">And</span> QS<span class="token punctuation">.</span>total_elapsed_time <span class="token operator">/</span> QS<span class="token punctuation">.</span>execution_count <span class="token operator">/</span><span class="token number">1000</span> <span class="token operator">&gt;</span> <span class="token number">100</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>平均每次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关详细信息，请参阅：</p>`,7),k={href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-stats-transact-sql?view=sql-server-ver15#examples",target:"_blank",rel:"noopener noreferrer"},r={href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-sql-text-transact-sql?view=sql-server-ver15",target:"_blank",rel:"noopener noreferrer"},d={href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-query-plan-transact-sql?view=sql-server-ver15",target:"_blank",rel:"noopener noreferrer"},m=p(`<hr><h2 id="存储过程" tabindex="-1"><a class="header-anchor" href="#存储过程"><span>存储过程</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/*
 * 查询存储过程的平均每次执行用时
*/</span>
<span class="token keyword">SELECT</span> 
d<span class="token punctuation">.</span>database_id <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库ID<span class="token punctuation">]</span><span class="token punctuation">,</span>
DB_Name<span class="token punctuation">(</span>d<span class="token punctuation">.</span>database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库名称<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>object_id <span class="token keyword">as</span> <span class="token punctuation">[</span>存储过程ID<span class="token punctuation">]</span><span class="token punctuation">,</span>
OBJECT_NAME<span class="token punctuation">(</span>object_id<span class="token punctuation">,</span> database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>存储过程名称<span class="token punctuation">]</span><span class="token punctuation">,</span>   
d<span class="token punctuation">.</span>cached_time <span class="token keyword">as</span> <span class="token punctuation">[</span>创建缓存日期<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>last_execution_time <span class="token keyword">as</span> <span class="token punctuation">[</span>最后一次执行日期<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>last_elapsed_time<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>最后一次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>execution_count <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总次数<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>total_elapsed_time<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
d<span class="token punctuation">.</span>total_elapsed_time<span class="token operator">/</span>d<span class="token punctuation">.</span>execution_count<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">AS</span> <span class="token punctuation">[</span>平均每次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_procedure_stats <span class="token keyword">AS</span> d  
<span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>database_id <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">&#39;数据库名&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>平均每次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),v={href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-procedure-stats-transact-sql?view=sql-server-ver15",target:"_blank",rel:"noopener noreferrer"},_=p(`<hr><h2 id="触发器" tabindex="-1"><a class="header-anchor" href="#触发器"><span>触发器</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">/*
 * 查询触发器的平均每次执行用时
*/</span>
<span class="token keyword">SELECT</span> 
d<span class="token punctuation">.</span>database_id <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库ID<span class="token punctuation">]</span><span class="token punctuation">,</span>
DB_NAME<span class="token punctuation">(</span>database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>数据库名称<span class="token punctuation">]</span><span class="token punctuation">,</span> 
d<span class="token punctuation">.</span>object_id <span class="token keyword">as</span> <span class="token punctuation">[</span>触发器ID<span class="token punctuation">]</span><span class="token punctuation">,</span>
OBJECT_NAME<span class="token punctuation">(</span>object_id<span class="token punctuation">,</span> database_id<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>触发器名称<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>cached_time <span class="token keyword">as</span> <span class="token punctuation">[</span>创建缓存日期<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>last_execution_time <span class="token keyword">as</span> <span class="token punctuation">[</span>最后一次执行日期<span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>last_elapsed_time <span class="token keyword">as</span> <span class="token punctuation">[</span>最后一次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>total_elapsed_time<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>  
d<span class="token punctuation">.</span>execution_count<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>执行总用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
d<span class="token punctuation">.</span>total_elapsed_time<span class="token operator">/</span>d<span class="token punctuation">.</span>execution_count<span class="token operator">/</span><span class="token number">1000</span> <span class="token keyword">as</span> <span class="token punctuation">[</span>平均每次执行用时<span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">]</span>  
<span class="token keyword">FROM</span> sys<span class="token punctuation">.</span>dm_exec_trigger_stats <span class="token keyword">AS</span> d  
<span class="token keyword">WHERE</span> d<span class="token punctuation">.</span>database_id <span class="token operator">=</span> DB_ID<span class="token punctuation">(</span><span class="token string">&#39;数据库名&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">ORDER</span> <span class="token keyword">BY</span> <span class="token punctuation">[</span>total_worker_time<span class="token punctuation">]</span> <span class="token keyword">DESC</span><span class="token punctuation">;</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),b={href:"https://docs.microsoft.com/zh-cn/sql/relational-databases/system-dynamic-management-views/sys-dm-exec-trigger-stats-transact-sql?view=sql-server-ver15",target:"_blank",rel:"noopener noreferrer"};function y(w,h){const a=o("ExternalLinkIcon");return c(),l("div",null,[i,n("p",null,[n("a",k,[s("sys.dm_exec_query_stats (Transact-SQL)"),t(a)])]),n("p",null,[n("a",r,[s("sys.dm_exec_sql_text (Transact-SQL)"),t(a)])]),n("p",null,[n("a",d,[s("sys.dm_exec_query_plan (Transact-SQL)"),t(a)])]),m,n("p",null,[s("有关详细信息，请参阅："),n("a",v,[s("sys.dm_exec_procedure_stats (Transact-SQL)"),t(a)])]),_,n("p",null,[s("有关详细信息，请参阅："),n("a",b,[s("sys.dm_exec_trigger_stats (Transact-SQL)"),t(a)])])])}const q=e(u,[["render",y],["__file","sqlserver-performance-analysis-query-satas.html.vue"]]),x=JSON.parse('{"path":"/sql-server/sqlserver-performance-analysis-query-satas.html","title":"执行计划的统计信息","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"SQL语句","slug":"sql语句","link":"#sql语句","children":[]},{"level":2,"title":"存储过程","slug":"存储过程","link":"#存储过程","children":[]},{"level":2,"title":"触发器","slug":"触发器","link":"#触发器","children":[]}],"git":{"updatedTime":1709905504000},"filePathRelative":"sql-server/sqlserver-performance-analysis-query-satas.md"}');export{q as comp,x as data};
