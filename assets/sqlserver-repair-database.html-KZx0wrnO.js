import{_ as t,r as c,o,c as i,a as n,d as s,b as a,e as l}from"./app-CUvyzFzm.js";const r={},d=l(`<h1 id="sql-server-修复数据库" tabindex="-1"><a class="header-anchor" href="#sql-server-修复数据库"><span>SQL Server 修复数据库</span></a></h1><h2 id="_1-检查数据库" tabindex="-1"><a class="header-anchor" href="#_1-检查数据库"><span>1 检查数据库</span></a></h2><h3 id="dbcc-checkdb" tabindex="-1"><a class="header-anchor" href="#dbcc-checkdb"><span>DBCC CHECKDB</span></a></h3><p>执行 <code>DBCC CHECKDB</code> 检查数据库中所有对象的逻辑和物理完整性</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 检查当前数据库。</span>
<span class="token keyword">DBCC</span> CHECKDB<span class="token punctuation">;</span>

<span class="token comment">-- 检查指定的数据库。</span>
<span class="token keyword">DBCC</span> CHECKDB <span class="token punctuation">(</span>database_name<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p><code>DBCC CHECKDB</code> 命令会执行以下操作：</p><ul><li>对数据库中的每个表和视图运行 <code>DBCC CHECKTABLE</code>。</li><li>对数据库运行 <code>DBCC CHECKALLOC</code>。</li><li>对数据库运行 <code>DBCC CHECKCATALOG</code>。</li><li>验证数据库中每个索引视图的内容。</li><li>使用 FILESTREAM 在文件系统中存储 varbinary(max) 数据时，验证表元数据和文件系统目录和- 文件之间的链接级一致性。</li><li>验证数据库中的 Service Broker 数据。</li></ul></div>`,6),p={href:"https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql?view=sql-server-ver16",target:"_blank",rel:"noopener noreferrer"},u=l(`<h3 id="dbcc-checktable" tabindex="-1"><a class="header-anchor" href="#dbcc-checktable"><span>DBCC CHECKTABLE</span></a></h3><p>执行 <code>DBCC CHECKTABLE</code> 检查指定表的逻辑和物理完整性</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 检查当前数据库中所有表。</span>
<span class="token keyword">DBCC</span> CHECKTABLE<span class="token punctuation">;</span>

<span class="token comment">-- 检查当前数据库中指定的表。</span>
<span class="token keyword">DBCC</span> CHECKTABLE <span class="token punctuation">(</span>table_name<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- 检查指定的数据库和指定的表（eg：&#39;AdventureWorks2022.dbo.MyTable&#39;）。</span>
<span class="token keyword">DBCC</span> CHECKTABLE <span class="token punctuation">(</span><span class="token string">&#39;database_name.schema_name.table_name&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,3),v={href:"https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql?view=sql-server-ver16",target:"_blank",rel:"noopener noreferrer"},k=l(`<h2 id="_2-分析-dbcc-结果" tabindex="-1"><a class="header-anchor" href="#_2-分析-dbcc-结果"><span>2 分析 DBCC 结果</span></a></h2><p>检查 <code>DBCC CHECKDB</code> 或者 <code>DBCC CHECKTABLE</code> 命令的结果，若存错误信息，则表示数据库存在错误，需要执行数据库修复。</p><p>例如，下面的结果说明 <code>SMInvoiceDetailWPDoorInfo</code> 表存在错误。</p><div class="sqlserver-repair-database-dbcc-checkdb-result"><div class="error-message"><p>消息 2575，级别 16，状态 1，第 1 行</p><p>索引分配映射(IAM)页 (1:2047648) (位于对象 ID 253217394，索引 ID 1，分区 ID 72057594780712960，分配单元 ID 72057594789625856 (类型为 In-row data))的下一个指针指向了 IAM 页 (1:2567845)，但扫描过程中检测不到它。</p><p>消息 2576，级别 16，状态 1，第 1 行</p><p>索引分配映射(IAM)页 (1:3027795) (位于对象 ID 253217394，索引 ID 1，分区 ID 72057594780712960，分配单元 ID 72057594789625856 (类型为 In-row data))的上一个指针指向了 IAM 页 (1:2567845)，但扫描过程中检测不到它。</p><p>消息 7965，级别 16，状态 2，第 1 行</p><p>表错误: 由于无效的分配(IAM)页，无法检查对象 ID 253217394，索引 ID 1，分区 ID 72057594780712960，分配单元 ID 72057594789625856 (类型为 In-row data)。</p></div><p>SMInvoiceDetailWPDoorInfo的 DBCC 结果。</p><p>对象 &#39;SMInvoiceDetailWPDoorInfo&#39; 的 0 页中有 0 行。</p><p>CHECKDB 在表 &#39;SMInvoiceDetailWPDoorInfo&#39; (对象 ID 253217394)中发现 2 个分配错误和 1 个一致性错误。</p></div><h2 id="_3-将数据库设置单用户模式" tabindex="-1"><a class="header-anchor" href="#_3-将数据库设置单用户模式"><span>3 将数据库设置单用户模式</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 将 AdventureWorks2019 数据库设置为单用户模式，并指定 ROLLBACK IMMEDIATE 立刻回滚所有未完成的事务。</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2019
<span class="token keyword">SET</span> SINGLE_USER
<span class="token keyword">WITH</span> <span class="token keyword">ROLLBACK</span> IMMEDIATE<span class="token punctuation">;</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,6),h={href:"https://learn.microsoft.com/zh-cn/sql/t-sql/statements/alter-database-transact-sql-set-options?view=sql-server-ver16#single_user",target:"_blank",rel:"noopener noreferrer"},C=l(`<h2 id="_4-执行修复操作" tabindex="-1"><a class="header-anchor" href="#_4-执行修复操作"><span>4 执行修复操作</span></a></h2><p>Microsoft 始终建议用户从上次已知成功备份还原，作为从 DBCC CHECKDB 报告的错误恢复的主要方法。</p><h3 id="执行不会丢失数据的修复" tabindex="-1"><a class="header-anchor" href="#执行不会丢失数据的修复"><span>执行不会丢失数据的修复</span></a></h3><p>使用 <code>REPAIR_REBUILD</code> 选项会重建损坏的索引，并重建损坏的表，但可能无法修复所有错误。</p><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token keyword">DBCC</span> CHECKDB <span class="token punctuation">(</span> AdventureWorks2019<span class="token punctuation">,</span> REPAIR_REBUILD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 修复 AdventureWorks2019 数据库</span>
<span class="token keyword">DBCC</span> CHECKDB <span class="token punctuation">(</span> AdventureWorks2019<span class="token punctuation">,</span> REPAIR_REBUILD <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 修复 AdventureWorks2019 数据库中的 DatabaseLog 表</span>
<span class="token keyword">DBCC</span> CHECKTABLE<span class="token punctuation">(</span> <span class="token punctuation">[</span>AdventureWorks2019<span class="token punctuation">.</span>dbo<span class="token punctuation">.</span>DatabaseLog<span class="token punctuation">]</span><span class="token punctuation">,</span> REPAIR_REBUILD <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="执行可能会丢失数据的修复" tabindex="-1"><a class="header-anchor" href="#执行可能会丢失数据的修复"><span>执行可能会丢失数据的修复</span></a></h3><p>使用 <code>REPAIR_ALLOW_DATA_LOSS</code> 选项尝试修复所有错误，但可能会导致一些数据丢失。</p><div class="custom-container danger"><p class="custom-container-title">警告</p><p><code>REPAIR_ALLOW_DATA_LOSS</code> 选项仅当不可从备份恢复时建议作为“最后手段”使用。 因为就算执行成功，但是它可能导致的数据丢失多于用户从上次已知成功备份还原数据库导致的数据丢失。</p></div><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 修复 AdventureWorks2019 数据库</span>
<span class="token keyword">DBCC</span> CHECKDB <span class="token punctuation">(</span> AdventureWorks2019<span class="token punctuation">,</span> REPAIR_ALLOW_DATA_LOSS <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 修复 AdventureWorks2019 数据库中的 DatabaseLog 表</span>
<span class="token keyword">DBCC</span> CHECKTABLE<span class="token punctuation">(</span> <span class="token string">&#39;AdventureWorks2016.dbo.DatabaseLog&#39;</span><span class="token punctuation">,</span> REPAIR_ALLOW_DATA_LOSS <span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>有关详细信息，请参阅：</p>`,10),m={href:"https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-checkdb-transact-sql?view=sql-server-ver16",target:"_blank",rel:"noopener noreferrer"},b={href:"https://learn.microsoft.com/zh-cn/sql/t-sql/database-console-commands/dbcc-checktable-transact-sql?view=sql-server-ver16",target:"_blank",rel:"noopener noreferrer"},_=l(`<h2 id="_5-重新检查数据库" tabindex="-1"><a class="header-anchor" href="#_5-重新检查数据库"><span>5 重新检查数据库</span></a></h2><p>查询数据库（步骤1），若结果无错误，则表示数据库修复成功，继续往下操作（步骤6），否则继续执行修复操作（步骤4）。</p><h2 id="_6-将数据库恢复多用户模式" tabindex="-1"><a class="header-anchor" href="#_6-将数据库恢复多用户模式"><span>6 将数据库恢复多用户模式</span></a></h2><div class="language-sql line-numbers-mode" data-ext="sql" data-title="sql"><pre class="language-sql"><code><span class="token comment">-- 恢复 AdventureWorks2019 数据库多用户模式。</span>
<span class="token keyword">ALTER</span> <span class="token keyword">DATABASE</span> AdventureWorks2019
<span class="token keyword">SET</span> MULTI_USER<span class="token punctuation">;</span>
GO
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_7-完成" tabindex="-1"><a class="header-anchor" href="#_7-完成"><span>7 完成</span></a></h2>`,5);function D(E,A){const e=c("ExternalLinkIcon");return o(),i("div",null,[d,n("p",null,[s("有关详细信息，请参阅 "),n("a",p,[s("DBCC CHECKDB (Transact-SQL)"),a(e)]),s("。")]),u,n("p",null,[s("有关详细信息，请参阅 "),n("a",v,[s("DBCC CHECKTABLE (Transact-SQL)"),a(e)]),s("。")]),k,n("p",null,[s("有关详细信息，请参阅 "),n("a",h,[s("ALTER DATABASE SET 选项 (Transact-SQL)"),a(e)]),s("。")]),C,n("ul",null,[n("li",null,[n("a",m,[s("DBCC CHECKDB (Transact-SQL)"),a(e)]),s("。")]),n("li",null,[n("a",b,[s("DBCC CHECKTABLE (Transact-SQL)"),a(e)]),s("。")])]),_])}const L=t(r,[["render",D],["__file","sqlserver-repair-database.html.vue"]]),q=JSON.parse('{"path":"/sql-server/sqlserver-repair-database.html","title":"SQL Server 修复数据库","lang":"zh-CN","frontmatter":{},"headers":[{"level":2,"title":"1 检查数据库","slug":"_1-检查数据库","link":"#_1-检查数据库","children":[{"level":3,"title":"DBCC CHECKDB","slug":"dbcc-checkdb","link":"#dbcc-checkdb","children":[]},{"level":3,"title":"DBCC CHECKTABLE","slug":"dbcc-checktable","link":"#dbcc-checktable","children":[]}]},{"level":2,"title":"2 分析 DBCC 结果","slug":"_2-分析-dbcc-结果","link":"#_2-分析-dbcc-结果","children":[]},{"level":2,"title":"3 将数据库设置单用户模式","slug":"_3-将数据库设置单用户模式","link":"#_3-将数据库设置单用户模式","children":[]},{"level":2,"title":"4 执行修复操作","slug":"_4-执行修复操作","link":"#_4-执行修复操作","children":[{"level":3,"title":"执行不会丢失数据的修复","slug":"执行不会丢失数据的修复","link":"#执行不会丢失数据的修复","children":[]},{"level":3,"title":"执行可能会丢失数据的修复","slug":"执行可能会丢失数据的修复","link":"#执行可能会丢失数据的修复","children":[]}]},{"level":2,"title":"5 重新检查数据库","slug":"_5-重新检查数据库","link":"#_5-重新检查数据库","children":[]},{"level":2,"title":"6 将数据库恢复多用户模式","slug":"_6-将数据库恢复多用户模式","link":"#_6-将数据库恢复多用户模式","children":[]},{"level":2,"title":"7 完成","slug":"_7-完成","link":"#_7-完成","children":[]}],"git":{"updatedTime":1716544964000},"filePathRelative":"sql-server/sqlserver-repair-database.md"}');export{L as comp,q as data};
